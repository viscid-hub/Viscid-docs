
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>viscid.rotation &#8212; Viscid 1.0.0.dev14 documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<link rel="icon" href="../../_static/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="../../_static/favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon-precomposed" href="../../_static/Vicon_128.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="stylesheet" href="../../_static/my-css.css" type="text/css" />

<script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          Viscid</a>
        <span class="navbar-text navbar-version pull-left"><b>1.0.0.dev14</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
    <li class="dropdown">
      <a role="button"
         id="dLabelNavLinxToc"
         data-toggle="dropdown"
         data-target="#"
         href="#">Tutorial <b class="caret"></b></a>
      <ul class="dropdown-menu navlinktoc"
          role="menu">
          <li class="toctree-l1">
            <a class="reference internal", href="../../installation.html">Installation</a>
          </li>
          <li class="toctree-l1">
            <a class="reference internal", href="../../tutorial/load_save.html">Loading & Saving</a>
          </li>
          <li class="toctree-l1">
            <a class="reference internal", href="../../tutorial/creating_fields.html">Creating Fields</a>
          </li>
          <li class="toctree-l1">
            <a class="reference internal", href="../../tutorial/slicing.html">Slicing Fields</a>
          </li>
          <li class="toctree-l1">
            <a class="reference internal", href="../../tutorial/plotting_scalars.html">Plotting Scalars</a>
          </li>
          <li class="toctree-l1">
            <a class="reference internal", href="../../tutorial/plotting_vectors.html">Plotting Vectors</a>
          </li>
          <li class="toctree-l1">
            <a class="reference internal", href="../../tutorial/mayavi.html">3D Plots (Mayavi)</a>
          </li>
          <li class="toctree-l1">
            <a class="reference internal", href="../../tutorial/openggcm.html">OpenGGCM Specific</a>
          </li>
          <li class="toctree-l1">
            <a class="reference internal", href="../../tutorial/ionosphere.html">Ionosphere</a>
          </li>
          <li class="toctree-l1">
            <a class="reference internal", href="../../tutorial/stream_and_interp.html">Streamline and Interpolation</a>
          </li>
          <li class="toctree-l1">
            <a class="reference internal", href="../../tutorial/magnetic_topology.html">Magnetic Topology</a>
          </li>
          <li class="toctree-l1">
            <a class="reference internal", href="../../tutorial/magnetopause.html">Magnetopause</a>
          </li>
          <li class="toctree-l1">
            <a class="reference internal", href="../../tutorial/quasi_potential.html">Quasi Potential</a>
          </li>
      </ul>
    </li>

            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../philosophy.html">Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../indexing.html">Indexing Fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/index.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../functions.html">Useful Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plot_options.html">Plot Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tips_and_tricks.html">Tips &amp; Tricks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../custom_behavior.html">Custom Behavior (rc file)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mpl_style_gallery.html">Matplotlib Style Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev_guide.html">Developerâ€™s Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/viscid.html">API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../changes.html">ChangeLog</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content" role="main">
      
  <h1>Source code for viscid.rotation</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env bash</span>
<span class="sd">&quot;&quot;&quot;Euler angle &lt;-&gt; Rotation matrix &lt;-&gt; quaternion conversions</span>

<span class="sd">This module is designed to work with Numpy versions 1.9+</span>

<span class="sd">Quaternion functions will work with vanilla Numpy, but they can also</span>
<span class="sd">make use of `this quaternion library &lt;https://github.com/moble/quaternion&gt;`_.</span>
<span class="sd">It is probably to your benefit to use a library that explicitly</span>
<span class="sd">implements quaternion algebra.</span>

<span class="sd">Note:</span>
<span class="sd">    If a function in this module has the same name as one in Matlab,</span>
<span class="sd">    the conventions used for the functions are the same.</span>

<span class="sd">Conventions:</span>
<span class="sd">    Rotation matrices and Euler angles are notoriously ambiguous due to</span>
<span class="sd">    competing conventions for order and meaning. Hopefully this section</span>
<span class="sd">    makes it clear which conventions are used in which functions.</span>

<span class="sd">    - **What is rotating**</span>
<span class="sd">        Rotations always follow the right hand rule, but can mean two</span>
<span class="sd">        things depending what is rotating.</span>

<span class="sd">        * **Extrinsic rotations** ``*rot*``</span>
<span class="sd">            Axes remain fixed, and matrices rotate vectors. This</span>
<span class="sd">            convention is used in functions with ``rot`` in their names</span>
<span class="sd">            to mirror Matlab&#39;s Robotics System toolkit. For example::</span>

<span class="sd">            &gt;&gt;&gt; e_rot(numpy.pi / 2, &#39;z&#39;) @ [1, 0, 0] = [0, 1, 0]</span>

<span class="sd">        * **Intrinsic rotations** ``*dcm*``</span>
<span class="sd">            Vectors remain fixed, but matrices rotate axes. This</span>
<span class="sd">            convention is used in functions with ``dcm`` in their names</span>
<span class="sd">            to mirror Matlab&#39;s Aerospace toolkit. For example::</span>

<span class="sd">            &gt;&gt;&gt; e_dcm(numpy.pi / 2, &#39;z&#39;) @ [1, 0, 0] = [0, -1, 0]</span>

<span class="sd">    - **Axis Order**</span>
<span class="sd">        For functions that deal with Euler angles, their order can be</span>
<span class="sd">        specified in two ways</span>

<span class="sd">        * **Multiplication order** ``*eul*``</span>
<span class="sd">            Axes are specified in the same order as the multiplication</span>
<span class="sd">            of the elementary matrices. In other words, the last axis</span>
<span class="sd">            specified is the first rotation applied. This convention is</span>
<span class="sd">            used in functions with ``eul`` in their names to mirror</span>
<span class="sd">            Matlab&#39;s Robotics System toolkit.</span>

<span class="sd">        * **Transformation order** ``*angle*``</span>
<span class="sd">            Axes are specified in the order that they are applied. In</span>
<span class="sd">            other words, the first axis is the first rotation, or the</span>
<span class="sd">            right-most matrix. This convention is used in functions with</span>
<span class="sd">            ``angle`` in their names to mirror Matlab&#39;s Aerospace toolkit.</span>

<span class="sd">Functions:</span>
<span class="sd">    - angle2rot: Euler angles (transform-order) -&gt; rotation matrix (extrinsic)</span>
<span class="sd">    - eul2rot: Euler angles (multiplication-order) -&gt; rotation matrix (extrinsic)</span>
<span class="sd">    - angle2dcm: Euler angles (transform-order) -&gt; rotation matrix (intrinsic)</span>
<span class="sd">    - eul2dcm: Euler angles (multiplication-order) -&gt; rotation matrix (intrinsic)</span>

<span class="sd">    - rot2angle: Rotation matrix (extrinsic) -&gt; Euler angles (transform-order)</span>
<span class="sd">    - rot2eul: Rotation matrix (extrinsic) -&gt; Euler angles (multiplication-order)</span>
<span class="sd">    - dcm2angle: Rotation matrix (intrinsic) -&gt; Euler angles (transform-order)</span>
<span class="sd">    - dcm2eul: Rotation matrix (intrinsic) -&gt; Euler angles (multiplication-order)</span>

<span class="sd">    - rot2quat: Rotation matrix (extrinsic) -&gt; quaternion</span>
<span class="sd">    - dcm2quat: Rotation matrix (intrinsic) -&gt; quaternion</span>
<span class="sd">    - quat2rot: Quaternion -&gt; rotation matrix (extrinsic)</span>
<span class="sd">    - quat2dcm: Quaternion -&gt; rotation matrix (intrinsic)</span>

<span class="sd">    - rotmul: Multiply rotation matrices together</span>
<span class="sd">    - rotate: Rotate R3 vector(s) by one or more matrices</span>

<span class="sd">    - quatmul: Multiply quaternions together</span>
<span class="sd">    - quat_rotate: Rotate R3 vector(s) by one or more quaternions</span>

<span class="sd">    - wxyz2rot: (angle, axis) representation -&gt; rotation matrix</span>
<span class="sd">    - axang2rot: axis-angle representation -&gt; rotation matrix</span>
<span class="sd">    - rot2wxyz: rotation matrix -&gt; (angle, axis) representation</span>
<span class="sd">    - rot2axang: rotation matrix -&gt; axis-angle representation</span>

<span class="sd">    - wxyz2quat: (angle, axis) representation -&gt; quaternion</span>
<span class="sd">    - axang2quat: axis-angle representation -&gt; quaternion</span>
<span class="sd">    - quat2wxyz: quaternion -&gt; (angle, axis) representation</span>
<span class="sd">    - quat2axang: quaternion -&gt; axis-angle representation</span>

<span class="sd">    - convert_angle: deg &lt;-&gt; rad conversion</span>
<span class="sd">    - check_orthonormality: checks that determinant is +1</span>

<span class="sd">    - e_rot: elementary rotation matrix (extrinsic)</span>
<span class="sd">    - e_dcm: elementary direction cosine matrix (intrinsic)</span>

<span class="sd">    - angle_between: angle between two vectors</span>
<span class="sd">    - a2b_rot: make rotation matrix that rotates vector a to vector b</span>

<span class="sd">    - symbolic_e_dcm: Make symbolic (sympy) elementary DCM</span>
<span class="sd">    - symbolic_e_rot: Make symbolic (sympy) elementary rotation matrix</span>
<span class="sd">    - symbolic_rot: Make symbolic (sympy) rotation matrix</span>
<span class="sd">    - symbolic_dcm: Make symbolic (sympy) DCM</span>

<span class="sd">Aliases:</span>
<span class="sd">    All functions work with stacks of transformations, so &quot;angles&quot;</span>
<span class="sd">    is natural in some contexts,</span>

<span class="sd">        - convert_angles = convert_angle</span>
<span class="sd">        - angles2rot -&gt; angle2rot</span>
<span class="sd">        - angles2dcm -&gt; angle2dcm</span>
<span class="sd">        - rot2angles -&gt; rot2angle</span>
<span class="sd">        - dcm2angles -&gt; dcm2angle</span>

<span class="sd">    The Matlab Robotics System Toolbox uses &quot;rotm&quot; for</span>
<span class="sd">    &quot;rotation matrix&quot; (rot)</span>

<span class="sd">        - eul2rotm -&gt; eul2rot</span>
<span class="sd">        - angle2rotm -&gt; angle2rot</span>
<span class="sd">        - angles2rotm -&gt; angles2rot</span>

<span class="sd">        - rotm2eul -&gt; rot2eul</span>
<span class="sd">        - rotm2angle -&gt; rot2angle</span>
<span class="sd">        - rotm2angles -&gt; rot2angles</span>

<span class="sd">        - rotm2quat -&gt; rot2quat</span>
<span class="sd">        - quat2rotm -&gt; quat2rot</span>

<span class="sd">        - a2b_rotm -&gt; a2b_rot</span>

<span class="sd">        - axang2rotm -&gt; axang2rot</span>
<span class="sd">        - rotm2axang -&gt; rot2axang</span>
<span class="sd">        - wxyz2rotm -&gt; wxyz2rot</span>
<span class="sd">        - rotm2wxyz -&gt; rot2wxyz</span>

<span class="sd">This module is completely orthogonal to Viscid, so that it can be</span>
<span class="sd">ripped out and used more generally. Please note that Viscid is MIT</span>
<span class="sd">licensed, which requires attribution.</span>

<span class="sd">The MIT License (MIT)</span>
<span class="sd">Copyright (c) 2018 Kristofor Maynard</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># pylint: disable = too-many-lines, bad-whitespace, invalid-slice-index</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="c1"># Euler angles &lt;-&gt; rotation matrices</span>
           <span class="s1">&#39;angle2rot&#39;</span><span class="p">,</span> <span class="s1">&#39;eul2rot&#39;</span><span class="p">,</span> <span class="s1">&#39;angle2dcm&#39;</span><span class="p">,</span> <span class="s1">&#39;eul2dcm&#39;</span><span class="p">,</span>
           <span class="s1">&#39;rot2angles&#39;</span><span class="p">,</span> <span class="s1">&#39;rot2eul&#39;</span><span class="p">,</span> <span class="s1">&#39;dcm2angles&#39;</span><span class="p">,</span> <span class="s1">&#39;dcm2eul&#39;</span><span class="p">,</span>
           <span class="c1"># rotation matrices &lt;-&gt; quaternions</span>
           <span class="s1">&#39;rot2quat&#39;</span><span class="p">,</span> <span class="s1">&#39;dcm2quat&#39;</span><span class="p">,</span> <span class="s1">&#39;quat2rot&#39;</span><span class="p">,</span> <span class="s1">&#39;quat2dcm&#39;</span><span class="p">,</span>
           <span class="c1"># composing rotations / quaternions and applying them in R3</span>
           <span class="s1">&#39;rotmul&#39;</span><span class="p">,</span> <span class="s1">&#39;rotate&#39;</span><span class="p">,</span> <span class="s1">&#39;quatmul&#39;</span><span class="p">,</span> <span class="s1">&#39;quat_rotate&#39;</span><span class="p">,</span>
           <span class="c1"># axis-angle representation</span>
           <span class="s1">&#39;wxyz2rot&#39;</span><span class="p">,</span> <span class="s1">&#39;axang2rot&#39;</span><span class="p">,</span> <span class="s1">&#39;rot2wxyz&#39;</span><span class="p">,</span> <span class="s1">&#39;rot2axang&#39;</span><span class="p">,</span>
           <span class="s1">&#39;wxyz2quat&#39;</span><span class="p">,</span> <span class="s1">&#39;axang2quat&#39;</span><span class="p">,</span> <span class="s1">&#39;quat2wxyz&#39;</span><span class="p">,</span> <span class="s1">&#39;quat2axang&#39;</span><span class="p">,</span>
           <span class="c1"># misc.</span>
           <span class="s1">&#39;convert_angle&#39;</span><span class="p">,</span> <span class="s1">&#39;check_orthonormality&#39;</span><span class="p">,</span>
           <span class="s1">&#39;e_rot&#39;</span><span class="p">,</span> <span class="s1">&#39;e_dcm&#39;</span><span class="p">,</span>
           <span class="s1">&#39;angle_between&#39;</span><span class="p">,</span> <span class="s1">&#39;a2b_rot&#39;</span><span class="p">,</span>
           <span class="c1"># sympy symbolic functions</span>
           <span class="s1">&#39;symbolic_e_dcm&#39;</span><span class="p">,</span> <span class="s1">&#39;symbolic_e_rot&#39;</span><span class="p">,</span> <span class="s1">&#39;symbolic_rot&#39;</span><span class="p">,</span> <span class="s1">&#39;symbolic_dcm&#39;</span><span class="p">,</span>
           <span class="c1"># aliases</span>
           <span class="s1">&#39;convert_angles&#39;</span><span class="p">,</span>
           <span class="s1">&#39;angles2rot&#39;</span><span class="p">,</span> <span class="s1">&#39;angles2dcm&#39;</span><span class="p">,</span> <span class="s1">&#39;rot2angles&#39;</span><span class="p">,</span> <span class="s1">&#39;dcm2angles&#39;</span><span class="p">,</span>
           <span class="s1">&#39;eul2rotm&#39;</span><span class="p">,</span> <span class="s1">&#39;angle2rotm&#39;</span><span class="p">,</span> <span class="s1">&#39;angles2rotm&#39;</span><span class="p">,</span>
           <span class="s1">&#39;rotm2eul&#39;</span><span class="p">,</span> <span class="s1">&#39;rotm2angle&#39;</span><span class="p">,</span> <span class="s1">&#39;rotm2angles&#39;</span><span class="p">,</span>
           <span class="s1">&#39;rotm2quat&#39;</span><span class="p">,</span> <span class="s1">&#39;quat2rotm&#39;</span><span class="p">,</span>
           <span class="s1">&#39;a2b_rotm&#39;</span><span class="p">,</span> <span class="s1">&#39;axang2rotm&#39;</span><span class="p">,</span> <span class="s1">&#39;rotm2axang&#39;</span><span class="p">,</span> <span class="s1">&#39;wxyz2rotm&#39;</span><span class="p">,</span> <span class="s1">&#39;rotm2wxyz&#39;</span>
           <span class="p">]</span>


<div class="viewcode-block" id="convert_angle"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.convert_angle">[docs]</a><span class="k">def</span> <span class="nf">convert_angle</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">from_unit</span><span class="p">,</span> <span class="n">to_unit</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;convert angle(s) from rad/deg to rad/deg</span>

<span class="sd">    Args:</span>
<span class="sd">        angle (float, sequence): angle in from_unit</span>
<span class="sd">        from_unit (str): unit of angle, one of (&#39;rad&#39;, &#39;deg&#39;)</span>
<span class="sd">        to_unit (str): unit of result, one of (&#39;rad&#39;, &#39;deg&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        float or ndarray: angle converted to to_unit</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">from_unit</span> <span class="o">=</span> <span class="n">from_unit</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">to_unit</span> <span class="o">=</span> <span class="n">to_unit</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">from_unit</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;rad&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">to_unit</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;rad&#39;</span><span class="p">):</span>
        <span class="n">ret_angle</span> <span class="o">=</span> <span class="n">angle</span>
    <span class="k">elif</span> <span class="n">from_unit</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">to_unit</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;deg&#39;</span><span class="p">):</span>
        <span class="n">ret_angle</span> <span class="o">=</span> <span class="n">angle</span>
    <span class="k">elif</span> <span class="n">from_unit</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">to_unit</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;rad&#39;</span><span class="p">):</span>
        <span class="n">ret_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">from_unit</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;rad&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">to_unit</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;deg&#39;</span><span class="p">):</span>
        <span class="n">ret_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad angle units &#39;</span><span class="si">{0}</span><span class="s2">&#39; / &#39;</span><span class="si">{1}</span><span class="s2">&#39;&quot;</span>
                         <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">from_unit</span><span class="p">,</span> <span class="n">to_unit</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ret_angle</span></div>

<div class="viewcode-block" id="check_orthonormality"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.check_orthonormality">[docs]</a><span class="k">def</span> <span class="nf">check_orthonormality</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">bad_matrix</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check that a matrix or stack of matrices is orthonormal</span>

<span class="sd">    Args:</span>
<span class="sd">        mat (ndarray): A matrix with shape [Ndim, Ndim] or a stack of</span>
<span class="sd">            matrices with shape [Nmatrices, Ndim, Ndim]</span>
<span class="sd">        bad_matrix (str): What to do if ``numpy.det(R) != 1.0`` - can</span>
<span class="sd">            be one of (&#39;ignore&#39;, &#39;warn&#39;, &#39;raise&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_valid</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">bad_matrix</span> <span class="o">=</span> <span class="s1">&#39;ignore&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">bad_matrix</span> <span class="k">else</span> <span class="n">bad_matrix</span>
    <span class="n">bad_matrix</span> <span class="o">=</span> <span class="n">bad_matrix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">bad_matrix</span> <span class="o">!=</span> <span class="s1">&#39;ignore&#39;</span><span class="p">:</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="n">is_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">mat</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">8e-16</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">4e-16</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;numpy.linalg.det(mat) != 1.0&quot;</span>
            <span class="k">if</span> <span class="n">bad_matrix</span> <span class="o">==</span> <span class="s1">&#39;raise&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">bad_matrix</span> <span class="o">==</span> <span class="s1">&#39;warn&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">is_valid</span></div>

<div class="viewcode-block" id="e_rot"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.e_rot">[docs]</a><span class="k">def</span> <span class="nf">e_rot</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make elementary rotation matrices (extrinsic) of theta around axis</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; e_rot(numpy.pi / 2, &#39;z&#39;) @ [1, 0, 0] = [0, 1, 0]</span>

<span class="sd">    Args:</span>
<span class="sd">        theta (float, sequence): angle or angles</span>
<span class="sd">        axis (int, str): one of (0, &#39;x&#39;, 1, &#39;y&#39;, 2, &#39;z&#39;)</span>
<span class="sd">        unit (str): unit of theta, one of (&#39;deg&#39;, &#39;rad&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: rotation matrix with shape [ndim, ndim] or</span>
<span class="sd">            matrices with shape [Nmatrices, Ndim, Ndim]</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: invalid axis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">single_val</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">()</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">theta_rad</span> <span class="o">=</span> <span class="n">convert_angle</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="s1">&#39;rad&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">rotations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">theta_rad</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

    <span class="n">sinT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_rad</span><span class="p">)</span>
    <span class="n">cosT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_rad</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">rotations</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span>   <span class="mf">1.0</span>
        <span class="n">rotations</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>   <span class="n">cosT</span>
        <span class="n">rotations</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">sinT</span>
        <span class="n">rotations</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>   <span class="n">sinT</span>
        <span class="n">rotations</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span>   <span class="n">cosT</span>
    <span class="k">elif</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">rotations</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span>   <span class="n">cosT</span>
        <span class="n">rotations</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span>   <span class="n">sinT</span>
        <span class="n">rotations</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>   <span class="mf">1.0</span>
        <span class="n">rotations</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">sinT</span>
        <span class="n">rotations</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span>   <span class="n">cosT</span>
    <span class="k">elif</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">rotations</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span>   <span class="n">cosT</span>
        <span class="n">rotations</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">sinT</span>
        <span class="n">rotations</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span>   <span class="n">sinT</span>
        <span class="n">rotations</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>   <span class="n">cosT</span>
        <span class="n">rotations</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span>   <span class="mf">1.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid axis: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">axis</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">single_val</span><span class="p">:</span>
        <span class="n">rotations</span> <span class="o">=</span> <span class="n">rotations</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">rotations</span></div>

<div class="viewcode-block" id="e_dcm"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.e_dcm">[docs]</a><span class="k">def</span> <span class="nf">e_dcm</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make elementary rotation matrices (intrinsic) of theta around axis</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; e_dcm(numpy.pi / 2, &#39;z&#39;) @ [1, 0, 0] = [0, -1, 0]</span>

<span class="sd">    Args:</span>
<span class="sd">        theta (float, sequence): angle or angles</span>
<span class="sd">        axis (int, str): one of (0, &#39;x&#39;, 1, &#39;y&#39;, 2, &#39;z&#39;)</span>
<span class="sd">        unit (str): unit of theta, one of (&#39;deg&#39;, &#39;rad&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: rotation matrix with shape [ndim, ndim] or</span>
<span class="sd">            matrices with shape [Nmatrices, Ndim, Ndim]</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: invalid axis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">e_rot</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span></div>

<div class="viewcode-block" id="angle2rot"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.angle2rot">[docs]</a><span class="k">def</span> <span class="nf">angle2rot</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s1">&#39;zyx&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Euler angles (transform-order) -&gt; rotation matrix (extrinsic)</span>

<span class="sd">    Rotations are applied in transform-order, which means the first</span>
<span class="sd">    axis given is the first transform applied. In other words, the</span>
<span class="sd">    matrix multiply is in reverse order, i.e.::</span>

<span class="sd">        &gt;&gt;&gt; R = (R(angles[..., 2], axis[..., 2]) @</span>
<span class="sd">        &gt;&gt;&gt;      R(angles[..., 1], axis[..., 1]) @</span>
<span class="sd">        &gt;&gt;&gt;      R(angles[..., 0], axis[..., 0]))</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; angle2rot([numpy.pi / 2, 0, 0], &#39;zyx&#39;) @ [1, 0, 0] = [0, 1, 0]</span>

<span class="sd">    Args:</span>
<span class="sd">        angles (sequence): Euler angles in transform-order; can</span>
<span class="sd">            have shape [Ndim] or [Nmatrices, Ndim] to make stacked</span>
<span class="sd">            transform matrices</span>
<span class="sd">        axes (sequence, str): rotation axes in transform-order</span>
<span class="sd">        unit (str): unit of angles, one of (&#39;deg&#39;, &#39;rad&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: rotation matrix with shape [Ndim, Ndim] or</span>
<span class="sd">            [Nmatrices, Ndim, Ndim] depending on the shape of ``angles``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">single_val</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">angles</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>

    <span class="n">angles_rad</span> <span class="o">=</span> <span class="n">convert_angle</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="s1">&#39;rad&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">angles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must have 3 Euler angles&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must have one axis for each Euler angle&quot;</span><span class="p">)</span>

    <span class="n">R0</span> <span class="o">=</span> <span class="n">e_rot</span><span class="p">(</span><span class="n">angles_rad</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">)</span>
    <span class="n">R1</span> <span class="o">=</span> <span class="n">e_rot</span><span class="p">(</span><span class="n">angles_rad</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">)</span>
    <span class="n">R2</span> <span class="o">=</span> <span class="n">e_rot</span><span class="p">(</span><span class="n">angles_rad</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># raise AttributeError  # to test einsum timing</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">R2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="n">R0</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="c1"># fallback to einsum to support numpy 1.6 - 1.9</span>
        <span class="n">matmul_spec</span> <span class="o">=</span> <span class="s1">&#39;mik,mkj-&gt;mij&#39;</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="n">matmul_spec</span><span class="p">,</span> <span class="n">R2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="n">matmul_spec</span><span class="p">,</span> <span class="n">R1</span><span class="p">,</span> <span class="n">R0</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">single_val</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">R</span></div>

<div class="viewcode-block" id="eul2rot"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.eul2rot">[docs]</a><span class="k">def</span> <span class="nf">eul2rot</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s1">&#39;zyx&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Euler angles (multiplication-order) -&gt; rotation matrix (extrinsic)</span>

<span class="sd">    Rotations are applied in multiplication-order, which means the last</span>
<span class="sd">    axis given is the first transform applied. In other words::</span>

<span class="sd">        &gt;&gt;&gt; R = (R(angles[..., 0], axis[..., 0]) @</span>
<span class="sd">        &gt;&gt;&gt;      R(angles[..., 1], axis[..., 1]) @</span>
<span class="sd">        &gt;&gt;&gt;      R(angles[..., 2], axis[..., 2]))</span>

<span class="sd">    This function is equivalent (up to a few machine epsilon) to</span>
<span class="sd">    Matlab&#39;s ``eul2rotm``.</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; eul2rot([numpy.pi / 2, 0, 0], &#39;zyx&#39;) @ [1, 0, 0] = [0, 1, 0]</span>

<span class="sd">    Args:</span>
<span class="sd">        angles (sequence): Euler angles in multiplication-order; can</span>
<span class="sd">            have shape [Ndim] or [Nmatrices, Ndim] to make stacked</span>
<span class="sd">            transform matrices</span>
<span class="sd">        axes (sequence, str): rotation axes in multiplication-order</span>
<span class="sd">        unit (str): unit of angles, one of (&#39;deg&#39;, &#39;rad&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: rotation matrix with shape [Ndim, Ndim] or</span>
<span class="sd">            [Nmatrices, Ndim, Ndim] depending on the shape of ``angles``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">single_val</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">angles</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">angle2rot</span><span class="p">(</span><span class="n">angles</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">single_val</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">R</span></div>

<div class="viewcode-block" id="angle2dcm"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.angle2dcm">[docs]</a><span class="k">def</span> <span class="nf">angle2dcm</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s1">&#39;zyx&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Euler angles (transform-order) -&gt; rotation matrix (intrinsic)</span>

<span class="sd">    Rotations are applied in transform-order, which means the first</span>
<span class="sd">    axis given is the first transform applied. In other words, the</span>
<span class="sd">    matrix multiply is in reverse order, i.e.::</span>

<span class="sd">        &gt;&gt;&gt; R = (R(angles[..., 2], axis[..., 2]) @</span>
<span class="sd">        &gt;&gt;&gt;      R(angles[..., 1], axis[..., 1]) @</span>
<span class="sd">        &gt;&gt;&gt;      R(angles[..., 0], axis[..., 0]))</span>

<span class="sd">    This function is equivalent (up to a few machine epsilon) to</span>
<span class="sd">    Matlab&#39;s ``angle2dcm``.</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; angle2dcm([numpy.pi / 2, 0, 0], &#39;zyx&#39;) @ [1, 0, 0] = [0, -1, 0]</span>

<span class="sd">    Args:</span>
<span class="sd">        angles (sequence): Euler angles in transform-order; can</span>
<span class="sd">            have shape [Ndim] or [Nmatrices, Ndim] to make stacked</span>
<span class="sd">            transform matrices</span>
<span class="sd">        axes (sequence, str): rotation axes in transform-order</span>
<span class="sd">        unit (str): unit of angles, one of (&#39;deg&#39;, &#39;rad&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: rotation matrix with shape [Ndim, Ndim] or</span>
<span class="sd">            [Nmatrices, Ndim, Ndim] depending on the shape of ``angles``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">angle2rot</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span></div>

<div class="viewcode-block" id="eul2dcm"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.eul2dcm">[docs]</a><span class="k">def</span> <span class="nf">eul2dcm</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s1">&#39;zyx&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Euler angles (multiplication-order) -&gt; rotation matrix (intrinsic)</span>

<span class="sd">    Rotations are applied in multiplication-order, which means the last</span>
<span class="sd">    axis given is the first transform applied. In other words::</span>

<span class="sd">        &gt;&gt;&gt; R = (R(angles[..., 0], axis[..., 0]) @</span>
<span class="sd">        &gt;&gt;&gt;      R(angles[..., 1], axis[..., 1]) @</span>
<span class="sd">        &gt;&gt;&gt;      R(angles[..., 2], axis[..., 2]))</span>

<span class="sd">    Example:</span>

<span class="sd">        &gt;&gt;&gt; eul2dcm([numpy.pi / 2, 0, 0], &#39;zyx&#39;) @ [1, 0, 0] = [0, -1, 0]</span>

<span class="sd">    Args:</span>
<span class="sd">        angles (sequence): Euler angles in multiplication-order; can</span>
<span class="sd">            have shape [Ndim] or [Nmatrices, Ndim] to make stacked</span>
<span class="sd">            transform matrices</span>
<span class="sd">        axes (sequence, str): rotation axes in multiplication-order</span>
<span class="sd">        unit (str): unit of angles, one of (&#39;deg&#39;, &#39;rad&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: rotation matrix with shape [Ndim, Ndim] or</span>
<span class="sd">            [Nmatrices, Ndim, Ndim] depending on the shape of ``angles``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">single_val</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">angles</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">angle2dcm</span><span class="p">(</span><span class="n">angles</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">single_val</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">R</span></div>

<span class="k">def</span> <span class="nf">rot2angle</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s1">&#39;zyx&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">,</span> <span class="n">bad_matrix</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rotation matrix (extrinsic) -&gt; Euler angles (transform-order)</span>

<span class="sd">    Args:</span>
<span class="sd">        R (ndarray): A rotation matrix with shape [Ndim, Ndim] or a</span>
<span class="sd">            stack of matrices with shape [Nmatrices, Ndim, Ndim]</span>
<span class="sd">        axes (sequence, str): rotation axes in transform-order</span>
<span class="sd">        unit (str): Unit of angles, one of (&#39;deg&#39;, &#39;rad&#39;)</span>
<span class="sd">        bad_matrix (str): What to do if ``numpy.det(R) != 1.0`` - can</span>
<span class="sd">            be one of (&#39;ignore&#39;, &#39;warn&#39;, &#39;raise&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: Euler angles with shape [Ndim] or [Nmatrices, Ndim]</span>
<span class="sd">            depending on the input. ``angles[:, i]`` always corresponds</span>
<span class="sd">            to ``axes[i]``.</span>

<span class="sd">    See Also:</span>
<span class="sd">        * :py:func:`angle2rot` for more details about axes order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="n">single_val</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">single_val</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Rotation matrices must be 3x3 or 4x4&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must have one axis for each Euler angle&quot;</span><span class="p">)</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="n">check_orthonormality</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">bad_matrix</span><span class="o">=</span><span class="n">bad_matrix</span><span class="p">)</span>

    <span class="n">singular_threshold</span> <span class="o">=</span> <span class="mf">1e-10</span>

    <span class="k">if</span> <span class="n">axes</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;zyx&#39;</span><span class="p">,</span> <span class="s1">&#39;yxz&#39;</span><span class="p">,</span> <span class="s1">&#39;xzy&#39;</span><span class="p">,</span> <span class="s1">&#39;xyz&#39;</span><span class="p">,</span> <span class="s1">&#39;yzx&#39;</span><span class="p">,</span> <span class="s1">&#39;zxy&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">axes</span> <span class="o">==</span> <span class="s1">&#39;zyx&#39;</span><span class="p">:</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">c0c1</span><span class="p">,</span> <span class="n">s0c1</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">-</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">s2c1</span><span class="p">,</span> <span class="n">c2c1</span> <span class="o">=</span> <span class="o">-</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">s0p2</span><span class="p">,</span> <span class="n">c0p2</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">axes</span> <span class="o">==</span> <span class="s1">&#39;yxz&#39;</span><span class="p">:</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">c0c1</span><span class="p">,</span> <span class="n">s0c1</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="o">-</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">s2c1</span><span class="p">,</span> <span class="n">c2c1</span> <span class="o">=</span> <span class="o">-</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">s0p2</span><span class="p">,</span> <span class="n">c0p2</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">axes</span> <span class="o">==</span> <span class="s1">&#39;xzy&#39;</span><span class="p">:</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">c0c1</span><span class="p">,</span> <span class="n">s0c1</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="o">-</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">s2c1</span><span class="p">,</span> <span class="n">c2c1</span> <span class="o">=</span> <span class="o">-</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">s0p2</span><span class="p">,</span> <span class="n">c0p2</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">axes</span> <span class="o">==</span> <span class="s1">&#39;xyz&#39;</span><span class="p">:</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="o">-</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">c0c1</span><span class="p">,</span> <span class="n">s0c1</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">s2c1</span><span class="p">,</span> <span class="n">c2c1</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">s0p2</span><span class="p">,</span> <span class="n">c0p2</span> <span class="o">=</span> <span class="o">-</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">axes</span> <span class="o">==</span> <span class="s1">&#39;yzx&#39;</span><span class="p">:</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="o">-</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">c0c1</span><span class="p">,</span> <span class="n">s0c1</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">s2c1</span><span class="p">,</span> <span class="n">c2c1</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">s0p2</span><span class="p">,</span> <span class="n">c0p2</span> <span class="o">=</span> <span class="o">-</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">axes</span> <span class="o">==</span> <span class="s1">&#39;zxy&#39;</span><span class="p">:</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="o">-</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">c0c1</span><span class="p">,</span> <span class="n">s0c1</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">s2c1</span><span class="p">,</span> <span class="n">c2c1</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">s0p2</span><span class="p">,</span> <span class="n">c0p2</span> <span class="o">=</span> <span class="o">-</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">c1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c0c1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">s0c1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c0c1</span><span class="p">,</span> <span class="n">s0c1</span><span class="p">,</span> <span class="n">s2c1</span><span class="p">,</span> <span class="n">c2c1</span><span class="p">,</span> <span class="n">s0p2</span><span class="p">,</span> <span class="n">c0p2</span><span class="p">):</span>
            <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">arr</span><span class="p">)</span>
        <span class="n">is_singular</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">singular_threshold</span>

        <span class="n">angle0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_singular</span><span class="p">,</span>
                          <span class="mf">0.0</span><span class="p">,</span>
                          <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">s0c1</span> <span class="o">/</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c0c1</span> <span class="o">/</span> <span class="n">c1</span><span class="p">)</span>
                          <span class="p">)</span>
        <span class="n">angle1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">c1</span><span class="p">)</span>
        <span class="n">angle2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_singular</span><span class="p">,</span>
                          <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">s0p2</span><span class="p">,</span> <span class="n">c0p2</span><span class="p">),</span>
                          <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">s2c1</span> <span class="o">/</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2c1</span> <span class="o">/</span> <span class="n">c1</span><span class="p">)</span>
                          <span class="p">)</span>
    <span class="k">elif</span> <span class="n">axes</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;zyz&#39;</span><span class="p">,</span> <span class="s1">&#39;zxz&#39;</span><span class="p">,</span> <span class="s1">&#39;yzy&#39;</span><span class="p">,</span> <span class="s1">&#39;yxy&#39;</span><span class="p">,</span> <span class="s1">&#39;xzx&#39;</span><span class="p">,</span> <span class="s1">&#39;xyx&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">axes</span> <span class="o">==</span> <span class="s1">&#39;zyz&#39;</span><span class="p">:</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">s0s1</span><span class="p">,</span> <span class="n">c0s1</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="o">-</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">s1s2</span><span class="p">,</span> <span class="n">s1c2</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">s0p2</span><span class="p">,</span> <span class="n">c0p2</span> <span class="o">=</span> <span class="o">-</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">axes</span> <span class="o">==</span> <span class="s1">&#39;zxz&#39;</span><span class="p">:</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">s0s1</span><span class="p">,</span> <span class="n">c0s1</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">s1s2</span><span class="p">,</span> <span class="n">s1c2</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="o">-</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">s0p2</span><span class="p">,</span> <span class="n">c0p2</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">axes</span> <span class="o">==</span> <span class="s1">&#39;yzy&#39;</span><span class="p">:</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">s0s1</span><span class="p">,</span> <span class="n">c0s1</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">s1s2</span><span class="p">,</span> <span class="n">s1c2</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="o">-</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">s0p2</span><span class="p">,</span> <span class="n">c0p2</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">axes</span> <span class="o">==</span> <span class="s1">&#39;yxy&#39;</span><span class="p">:</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">s0s1</span><span class="p">,</span> <span class="n">c0s1</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">-</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">s1s2</span><span class="p">,</span> <span class="n">s1c2</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">s0p2</span><span class="p">,</span> <span class="n">c0p2</span> <span class="o">=</span> <span class="o">-</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">axes</span> <span class="o">==</span> <span class="s1">&#39;xzx&#39;</span><span class="p">:</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">s0s1</span><span class="p">,</span> <span class="n">c0s1</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="o">-</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">s1s2</span><span class="p">,</span> <span class="n">s1c2</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">s0p2</span><span class="p">,</span> <span class="n">c0p2</span> <span class="o">=</span> <span class="o">-</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">axes</span> <span class="o">==</span> <span class="s1">&#39;xyx&#39;</span><span class="p">:</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">s0s1</span><span class="p">,</span> <span class="n">c0s1</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">s1s2</span><span class="p">,</span> <span class="n">s1c2</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">-</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">s0p2</span><span class="p">,</span> <span class="n">c0p2</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s0s1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c0s1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">s0s1</span><span class="p">,</span> <span class="n">c0s1</span><span class="p">,</span> <span class="n">s1s2</span><span class="p">,</span> <span class="n">s1c2</span><span class="p">,</span> <span class="n">s0p2</span><span class="p">,</span> <span class="n">c0p2</span><span class="p">):</span>
            <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">arr</span><span class="p">)</span>
        <span class="n">is_singular</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">singular_threshold</span>

        <span class="n">angle0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_singular</span><span class="p">,</span>
                          <span class="mf">0.0</span><span class="p">,</span>
                          <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">s0s1</span><span class="p">,</span> <span class="n">c0s1</span><span class="p">)</span>
                          <span class="p">)</span>
        <span class="n">angle1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">c1</span><span class="p">)</span>
        <span class="n">angle2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_singular</span><span class="p">,</span>
                          <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">s0p2</span><span class="p">,</span> <span class="n">c0p2</span><span class="p">),</span>
                          <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">s1s2</span><span class="p">,</span> <span class="n">s1c2</span><span class="p">)</span>
                          <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;rot2eul not implemented for order &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">axes</span><span class="p">))</span>

    <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">angle0</span><span class="p">,</span> <span class="n">angle1</span><span class="p">,</span> <span class="n">angle2</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="k">if</span> <span class="n">single_val</span><span class="p">:</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">angles</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">convert_angle</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="s1">&#39;rad&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>

<div class="viewcode-block" id="rot2eul"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.rot2eul">[docs]</a><span class="k">def</span> <span class="nf">rot2eul</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s1">&#39;zyx&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">,</span> <span class="n">bad_matrix</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rotation matrix (extrinsic) -&gt; Euler angles (multiplication-order)</span>

<span class="sd">    Args:</span>
<span class="sd">        R (ndarray): A rotation matrix with shape [Ndim, Ndim] or a</span>
<span class="sd">            stack of matrices with shape [Nmatrices, Ndim, Ndim]</span>
<span class="sd">        axes (sequence, str): rotation axes in multiplication-order</span>
<span class="sd">        unit (str): Unit of angles, one of (&#39;deg&#39;, &#39;rad&#39;)</span>
<span class="sd">        bad_matrix (str): What to do if ``numpy.det(R) != 1.0`` - can</span>
<span class="sd">            be one of (&#39;ignore&#39;, &#39;warn&#39;, &#39;raise&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: Euler angles with shape [Ndim] or [Nmatrices, Ndim]</span>
<span class="sd">            depending on the input. ``angles[:, i]`` always corresponds</span>
<span class="sd">            to ``axes[i]``.</span>

<span class="sd">    See Also:</span>
<span class="sd">        * :py:func:`rot2eul` for more details about axes order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">rot2angle</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span> <span class="n">bad_matrix</span><span class="o">=</span><span class="n">bad_matrix</span><span class="p">)</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">angles</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">angles</span></div>

<span class="k">def</span> <span class="nf">dcm2angle</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s1">&#39;zyx&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">,</span> <span class="n">bad_matrix</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rotation matrix (intrinsic) -&gt; Euler angles (transform-order)</span>

<span class="sd">    Args:</span>
<span class="sd">        R (ndarray): A rotation matrix with shape [Ndim, Ndim] or a</span>
<span class="sd">            stack of matrices with shape [Nmatrices, Ndim, Ndim]</span>
<span class="sd">        axes (sequence, str): rotation axes in transform-order</span>
<span class="sd">        unit (str): Unit of angles, one of (&#39;deg&#39;, &#39;rad&#39;)</span>
<span class="sd">        bad_matrix (str): What to do if ``numpy.det(R) != 1.0`` - can</span>
<span class="sd">            be one of (&#39;ignore&#39;, &#39;warn&#39;, &#39;raise&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: Euler angles with shape [Ndim] or [Nmatrices, Ndim]</span>
<span class="sd">            depending on the input. ``angles[:, i]`` always corresponds</span>
<span class="sd">            to ``axes[i]``.</span>

<span class="sd">    See Also:</span>
<span class="sd">        * :py:func:`angle2dcm` for more details about axes order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="n">single_val</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">single_val</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">angles</span> <span class="o">=</span> <span class="n">rot2angle</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span>
                       <span class="n">bad_matrix</span><span class="o">=</span><span class="n">bad_matrix</span><span class="p">)[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">single_val</span><span class="p">:</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">angles</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>

    <span class="k">return</span> <span class="n">angles</span>

<div class="viewcode-block" id="dcm2eul"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.dcm2eul">[docs]</a><span class="k">def</span> <span class="nf">dcm2eul</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s1">&#39;zyx&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">,</span> <span class="n">bad_matrix</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rotation matrix (intrinsic) -&gt; Euler angles (multiplication-order)</span>

<span class="sd">    Args:</span>
<span class="sd">        R (ndarray): A rotation matrix with shape [Ndim, Ndim] or a</span>
<span class="sd">            stack of matrices with shape [Nmatrices, Ndim, Ndim]</span>
<span class="sd">        axes (sequence, str): rotation axes in multiplication-order</span>
<span class="sd">        unit (str): Unit of angles, one of (&#39;deg&#39;, &#39;rad&#39;)</span>
<span class="sd">        bad_matrix (str): What to do if ``numpy.det(R) != 1.0`` - can</span>
<span class="sd">            be one of (&#39;ignore&#39;, &#39;warn&#39;, &#39;raise&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: Euler angles with shape [Ndim] or [Nmatrices, Ndim]</span>
<span class="sd">            depending on the input. ``angles[:, i]`` always corresponds</span>
<span class="sd">            to ``axes[i]``.</span>

<span class="sd">    See Also:</span>
<span class="sd">        * :py:func:`eul2dcm` for more details about axes order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">dcm2angle</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span> <span class="n">bad_matrix</span><span class="o">=</span><span class="n">bad_matrix</span><span class="p">)</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">angles</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">angles</span></div>

<div class="viewcode-block" id="rot2quat"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.rot2quat">[docs]</a><span class="k">def</span> <span class="nf">rot2quat</span><span class="p">(</span><span class="n">R</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rotation matrix (extrinsic) -&gt; quaternion</span>

<span class="sd">    If `this quaternion library &lt;https://github.com/moble/quaternion&gt;`_</span>
<span class="sd">    is imported, then the results are presented with dtype quaternion,</span>
<span class="sd">    otherwise, as dtype numpy.double (array-of-struct,</span>
<span class="sd">    [scalar, vec0, vec1, vec2]).</span>

<span class="sd">    Args:</span>
<span class="sd">        R (ndarray): A rotation matrix with shape [Ndim, Ndim] or a</span>
<span class="sd">            stack of matrices with shape [Nmatrices, Ndim, Ndim]</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: quaternions with dtype quaternion with shape</span>
<span class="sd">            (Nmatrices,) or (); or with dtype numpy.double and shape</span>
<span class="sd">            (Nmatrices, 4) or (4)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="n">single_val</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">single_val</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Rotation matrices must be 3x3 or 4x4&quot;</span><span class="p">)</span>

    <span class="n">K3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">K3</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">R</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">R</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">3.0</span>
    <span class="n">K3</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">R</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">3.0</span>
    <span class="n">K3</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">R</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">3.0</span>
    <span class="n">K3</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">R</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">3.0</span>
    <span class="n">K3</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">K3</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">K3</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">R</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">R</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">3.0</span>
    <span class="n">K3</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">R</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">3.0</span>
    <span class="n">K3</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">R</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">3.0</span>
    <span class="n">K3</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">K3</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">K3</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">K3</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">K3</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">R</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">R</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">3.0</span>
    <span class="n">K3</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">R</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">3.0</span>
    <span class="n">K3</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">K3</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">K3</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">K3</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">K3</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">K3</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">K3</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">R</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">R</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">3.0</span>

    <span class="n">eigvals</span><span class="p">,</span> <span class="n">eigvecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">K3</span><span class="p">)</span>
    <span class="n">idx_evecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">eigvals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">selected_evecs</span> <span class="o">=</span> <span class="n">eigvecs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eigvecs</span><span class="p">)),</span> <span class="p">:,</span> <span class="n">idx_evecs</span><span class="p">]</span><span class="o">.</span><span class="n">real</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">),</span> <span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">q</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_evecs</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">q</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">selected_evecs</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">eigvecs</span><span class="p">,</span> <span class="n">selected_evecs</span>

    <span class="n">q</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s2">&quot;quaternion&quot;</span><span class="p">):</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">quaternion</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">single_val</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">q</span></div>

<div class="viewcode-block" id="dcm2quat"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.dcm2quat">[docs]</a><span class="k">def</span> <span class="nf">dcm2quat</span><span class="p">(</span><span class="n">R</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rotation matrix (intrinsic) -&gt; quaternion</span>

<span class="sd">    If `this quaternion library &lt;https://github.com/moble/quaternion&gt;`_</span>
<span class="sd">    is imported, then the results are presented with dtype quaternion,</span>
<span class="sd">    otherwise, as dtype numpy.double (array-of-struct,</span>
<span class="sd">    [scalar, vec0, vec1, vec2]).</span>

<span class="sd">    Args:</span>
<span class="sd">        R (ndarray): A rotation matrix with shape [Ndim, Ndim] or a</span>
<span class="sd">            stack of matrices with shape [Nmatrices, Ndim, Ndim]</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: quaternions with dtype quaternion and shape</span>
<span class="sd">            (Nmatrices,) or (); or with dtype numpy.double and shape</span>
<span class="sd">            (Nmatrices, 4) or (4)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">rot2quat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span></div>

<div class="viewcode-block" id="quat2rot"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.quat2rot">[docs]</a><span class="k">def</span> <span class="nf">quat2rot</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Quaternion -&gt; rotation matrix (extrinsic)</span>

<span class="sd">    Args:</span>
<span class="sd">        q (ndarray): quaternions with dtype quaternion and shape</span>
<span class="sd">            (Nmatrices,) or (); or with dtype numpy.double and shape</span>
<span class="sd">            (Nmatrices, 4) or (4)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: orthonormal rotation matrix with shape (3, 3)</span>
<span class="sd">            or (Nmatrices, 3, 3)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s1">&#39;quaternion&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">q</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;quaternion&#39;</span><span class="p">:</span>
        <span class="n">single_val</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">()</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">single_val</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="n">q_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">do_renorm</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">bitwise_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">q_norm</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">q_norm</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
    <span class="n">q</span><span class="p">[</span><span class="n">do_renorm</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/=</span> <span class="n">q_norm</span><span class="p">[</span><span class="n">do_renorm</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">q_norm</span><span class="p">,</span> <span class="n">do_renorm</span>

    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

    <span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">q</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">q</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">q</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">q</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>

    <span class="n">R</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">R</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="o">-</span> <span class="n">z</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
    <span class="n">R</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">z</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
    <span class="n">R</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
    <span class="n">R</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">R</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">z</span> <span class="o">-</span> <span class="n">x</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
    <span class="n">R</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">z</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
    <span class="n">R</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">z</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
    <span class="n">R</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">single_val</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">R</span></div>

<div class="viewcode-block" id="quat2dcm"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.quat2dcm">[docs]</a><span class="k">def</span> <span class="nf">quat2dcm</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Quaternion -&gt; rotation matrix (intrinsic)</span>

<span class="sd">    Args:</span>
<span class="sd">        q (ndarray): quaternions with dtype quaternion and shape</span>
<span class="sd">            (Nmatrices,) or (); or with dtype numpy.double and shape</span>
<span class="sd">            (Nmatrices, 4) or (4)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: rotation matrix with shape [Ndim, Ndim] or</span>
<span class="sd">            [Nmatrices, Ndim, Ndim] depending on the shape of ``q``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">quat2rot</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="rotmul"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.rotmul">[docs]</a><span class="k">def</span> <span class="nf">rotmul</span><span class="p">(</span><span class="o">*</span><span class="n">rmats</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Multiply rotation matrices together</span>

<span class="sd">    Args:</span>
<span class="sd">        *rmats (ndarrays): rotation matrices with shape (3, 3) or</span>
<span class="sd">            (nmats, 3, 3)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: rotation matrix with shape (3, 3) or (nmats, 3, 3)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">single_val</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">rmat</span> <span class="ow">in</span> <span class="n">rmats</span><span class="p">:</span>
        <span class="n">rmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rmat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rmat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">single_val</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">rmat</span> <span class="o">=</span> <span class="n">rmat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mij,mjk-&gt;mik&#39;</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">rmat</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">single_val</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">R</span></div>

<div class="viewcode-block" id="rotate"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.rotate">[docs]</a><span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="o">*</span><span class="n">rmats</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rotate R3 vector(s) by one or more matrices</span>

<span class="sd">    Args:</span>
<span class="sd">        vec (ndarray): R3 vectors with shape (3,) or (nvecs, 3)</span>
<span class="sd">        *rmats (ndarrays): rotation matrices with shape (3, 3) or</span>
<span class="sd">            (nmats, 3, 3)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: rotated vectors with shape (3,) or (nvecs, 3)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">rotmul</span><span class="p">(</span><span class="o">*</span><span class="n">rmats</span><span class="p">)</span>
    <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">single_val</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="n">vec</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="n">r_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mij,mj-&gt;mi&#39;</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">single_val</span><span class="p">:</span>
        <span class="n">r_vec</span> <span class="o">=</span> <span class="n">r_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">r_vec</span></div>

<div class="viewcode-block" id="quatmul"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.quatmul">[docs]</a><span class="k">def</span> <span class="nf">quatmul</span><span class="p">(</span><span class="o">*</span><span class="n">quats</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Multiply quaternions together</span>

<span class="sd">    Args:</span>
<span class="sd">        *quats (ndarrays): quaternions with dtype quaternion and shape</span>
<span class="sd">            () or (nquat,); or with dtype np.double and shape (4,) or</span>
<span class="sd">            (nquat, 4)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: with dtype quaternion and shape () or (nquat,); or</span>
<span class="sd">            with dtype np.double and shape (4,) or (nquat, 4)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">single_val</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s1">&#39;quaternion&#39;</span><span class="p">):</span>
        <span class="n">q0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;quaternion&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">quats</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;quaternion&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">():</span>
                    <span class="n">single_val</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">single_val</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;quaternion&#39;</span><span class="p">)</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">q0</span> <span class="o">=</span> <span class="n">q0</span> <span class="o">*</span> <span class="n">q</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">q0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">quats</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">single_val</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span> <span class="o">=</span> <span class="n">q0</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">q0</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">q0</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">q0</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
            <span class="n">b0</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span> <span class="o">=</span> <span class="n">q</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">q</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">q</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">q</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">q0</span><span class="p">):</span>
                <span class="n">q0</span> <span class="o">=</span> <span class="p">(</span><span class="n">q0</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                      <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">q0</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                      <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

            <span class="n">r</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a0</span> <span class="o">*</span> <span class="n">b0</span> <span class="o">-</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">b1</span> <span class="o">-</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">b2</span> <span class="o">-</span> <span class="n">a3</span> <span class="o">*</span> <span class="n">b3</span>
            <span class="n">r</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">b0</span> <span class="o">+</span> <span class="n">a0</span> <span class="o">*</span> <span class="n">b1</span> <span class="o">-</span> <span class="n">a3</span> <span class="o">*</span> <span class="n">b2</span> <span class="o">+</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">b3</span>
            <span class="n">r</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">b0</span> <span class="o">+</span> <span class="n">a3</span> <span class="o">*</span> <span class="n">b1</span> <span class="o">+</span> <span class="n">a0</span> <span class="o">*</span> <span class="n">b2</span> <span class="o">-</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">b3</span>
            <span class="n">r</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">a3</span> <span class="o">*</span> <span class="n">b0</span> <span class="o">-</span> <span class="n">a2</span> <span class="o">*</span> <span class="n">b1</span> <span class="o">+</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">b2</span> <span class="o">+</span> <span class="n">a0</span> <span class="o">*</span> <span class="n">b3</span>
            <span class="n">q0</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[:,</span> <span class="p">:]</span>

    <span class="k">if</span> <span class="n">single_val</span><span class="p">:</span>
        <span class="n">q0</span> <span class="o">=</span> <span class="n">q0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">q0</span></div>

<div class="viewcode-block" id="quat_rotate"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.quat_rotate">[docs]</a><span class="k">def</span> <span class="nf">quat_rotate</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="o">*</span><span class="n">quats</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rotate R3 vector(s) by one or more quaternions</span>

<span class="sd">    Args:</span>
<span class="sd">        vec (ndarray): R3 vectors with shape (3,) or (nvecs, 3)</span>
<span class="sd">        *quats (ndarrays): quaternions with dtype quaternion and shape</span>
<span class="sd">            () or (nquat,); or with dtype np.double and shape (4,) or</span>
<span class="sd">            (nquat, 4)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: rotated vectors with shape (3,) or (nvecs, 3)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">quatmul</span><span class="p">(</span><span class="o">*</span><span class="n">quats</span><span class="p">)</span>
    <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

    <span class="c1"># single_val = len(vec.shape) == 1 #and</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s1">&#39;quaternion&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">q</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;quaternion&#39;</span><span class="p">:</span>
        <span class="n">single_val</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">single_val</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)</span>

    <span class="c1"># turn input R3 vector into quaternion</span>
    <span class="n">vec</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">),</span> <span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">p</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">vec</span><span class="p">[:,</span> <span class="p">:]</span>
    <span class="k">del</span> <span class="n">vec</span>

    <span class="n">q_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">q_inv</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">q_inv</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">q_inv</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

    <span class="n">r_quat</span> <span class="o">=</span> <span class="n">quatmul</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q_inv</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r_quat</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">:])</span>

    <span class="k">if</span> <span class="n">single_val</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">r</span></div>

<div class="viewcode-block" id="wxyz2rot"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.wxyz2rot">[docs]</a><span class="k">def</span> <span class="nf">wxyz2rot</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make a matrix (matrices) that rotates around vector by angle</span>

<span class="sd">    Args:</span>
<span class="sd">        angle (sequence): angle(s) of rotation(s) with</span>
<span class="sd">            shape (), (1,), or (Nmatrices)</span>
<span class="sd">        vector (sequence): 3d vector(s) that is (are) axis of rotation(s)</span>
<span class="sd">            with shape (3,) or (Nmatrices, 3)</span>
<span class="sd">        unit (str): unit of angle, one of (&#39;deg&#39;, &#39;rad&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: orthonormal rotation matrix with shape (3, 3)</span>
<span class="sd">            or (Nmatrices, 3, 3)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

    <span class="n">single_val</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">vector</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">angle</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>

    <span class="n">theta_rad</span> <span class="o">=</span> <span class="n">convert_angle</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="s1">&#39;rad&#39;</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">vector</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">Nmatrices</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vector</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">Nmatrices</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

    <span class="n">K</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">k</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">K</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">k</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">K</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">k</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">K</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">k</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">K</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">k</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">K</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">k</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">Ksq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">Ksq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mik,mkj-&gt;mij&#39;</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>

    <span class="n">R</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
         <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">K</span>
         <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_rad</span><span class="p">))</span> <span class="o">*</span> <span class="n">Ksq</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">single_val</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

    <span class="k">return</span> <span class="n">R</span></div>

<div class="viewcode-block" id="axang2rot"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.axang2rot">[docs]</a><span class="k">def</span> <span class="nf">axang2rot</span><span class="p">(</span><span class="n">axang</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make a matrix (matrices) that rotates around vector by angle</span>

<span class="sd">    Args:</span>
<span class="sd">        axang (ndarray): axis(es) / angle(s) of rotation(s) put</span>
<span class="sd">            together like {x, y, z, angle}; shape should be (4,), or</span>
<span class="sd">            (Nmatrices, 4)</span>
<span class="sd">        unit (str): unit of angle, one of (&#39;deg&#39;, &#39;rad&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: orthonormal rotation matrix with shape (3, 3)</span>
<span class="sd">            or (Nmatrices, 3, 3)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">axang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">axang</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">axang</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">axang</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">wxyz2rot</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span></div>

<div class="viewcode-block" id="rot2wxyz"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.rot2wxyz">[docs]</a><span class="k">def</span> <span class="nf">rot2wxyz</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">,</span> <span class="n">quick</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bad_matrix</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find axis / angle representation of rotation matrix (matrices)</span>

<span class="sd">    Args:</span>
<span class="sd">        R (ndarray): Rotation matrix with shape (3, 3) determinant +1,</span>
<span class="sd">            or matrices with shape (Nmatrices, 3, 3)</span>
<span class="sd">        unit (str): unit of angle in results, one of (&#39;deg&#39;, &#39;rad&#39;)</span>
<span class="sd">        quick (bool): Try a quicker, less well tested method</span>
<span class="sd">        bad_matrix (str): What to do if ``numpy.det(R) != 1.0`` - can</span>
<span class="sd">            be one of (&#39;ignore&#39;, &#39;warn&#39;, &#39;raise&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        (w, xyz): ``w`` is rotation angle with shape () or (Nmatrices),</span>
<span class="sd">            and ``xyz`` are normalized rotation axes with shape (3,)</span>
<span class="sd">            or (Nmatrices, 3)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="n">single_val</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">single_val</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Rotation matrices must be 3x3&quot;</span><span class="p">)</span>

    <span class="n">check_orthonormality</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">bad_matrix</span><span class="o">=</span><span class="n">bad_matrix</span><span class="p">)</span>

    <span class="n">Nmatrices</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">quick</span><span class="p">:</span>
        <span class="c1"># I&#39;m not sure if I trust this method, although it is probably</span>
        <span class="c1"># quicker than calculating eigenvectors</span>
        <span class="n">ux</span> <span class="o">=</span> <span class="n">R</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">R</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">uy</span> <span class="o">=</span> <span class="n">R</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">R</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">uz</span> <span class="o">=</span> <span class="n">R</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">R</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ux</span><span class="p">,</span> <span class="n">uy</span><span class="p">,</span> <span class="n">uz</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">Nmatrices</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">R</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="n">null_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">null_mask</span><span class="p">):</span>
        <span class="c1"># calculate eigen vectors for transforms where the quick</span>
        <span class="c1"># method failed (or was never calculated)</span>
        <span class="n">eigval</span><span class="p">,</span> <span class="n">eigvecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="n">null_mask</span><span class="p">])</span>
        <span class="n">idx_evec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">eigval</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># eigenvector for eigenval closest to 1.0</span>
        <span class="n">u</span><span class="p">[</span><span class="n">null_mask</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">eigvecs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eigvecs</span><span class="p">)),</span> <span class="p">:,</span> <span class="n">idx_evec</span><span class="p">]</span><span class="o">.</span><span class="n">real</span>

    <span class="c1"># normalize axis vector</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">u</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># find a vector `b1` that is perpendicular to rotation axis `u`</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">Nmatrices</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">R</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">a</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">au_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">u</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># if au_diff &lt; 0.1 or au_diff &gt; 1.9:</span>
    <span class="n">a</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">bitwise_or</span><span class="p">(</span><span class="n">au_diff</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">au_diff</span> <span class="o">&gt;</span> <span class="mf">1.9</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># renormalize to minimize roundoff error</span>
    <span class="n">b1</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># rotate `b1` and then find the angle between result (`b2`) at `b1`</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mij,mj-&gt;mi&#39;</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">b1</span><span class="p">)</span>
    <span class="n">b2</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">b2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">angleB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">b1</span> <span class="o">*</span> <span class="n">b2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>

    <span class="c1"># fix sign of `u` to make the rotation angle right handed, note that</span>
    <span class="c1"># the angle will always be positive due to range or np.arccos</span>
    <span class="n">neg_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.0</span>
    <span class="n">u</span><span class="p">[</span><span class="n">neg_mask</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">angleB</span> <span class="o">=</span> <span class="n">convert_angle</span><span class="p">(</span><span class="n">angleB</span><span class="p">,</span> <span class="s1">&#39;rad&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">single_val</span><span class="p">:</span>
        <span class="n">angleB</span> <span class="o">=</span> <span class="n">angleB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>

    <span class="k">return</span> <span class="n">angleB</span><span class="p">,</span> <span class="n">u</span></div>

<div class="viewcode-block" id="rot2axang"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.rot2axang">[docs]</a><span class="k">def</span> <span class="nf">rot2axang</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">,</span> <span class="n">quick</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bad_matrix</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find axis / angle representation of rotation matrix (matrices)</span>

<span class="sd">    Args:</span>
<span class="sd">        R (ndarray): Rotation matrix with shape (3, 3) determinant +1,</span>
<span class="sd">            or matrices with shape (Nmatrices, 3, 3)</span>
<span class="sd">        unit (str): unit of angle in results, one of (&#39;deg&#39;, &#39;rad&#39;)</span>
<span class="sd">        quick (bool): Try a quicker, less well tested method</span>
<span class="sd">        bad_matrix (str): What to do if ``numpy.det(R) != 1.0`` - can</span>
<span class="sd">            be one of (&#39;ignore&#39;, &#39;warn&#39;, &#39;raise&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        (ndarray): {x, y, z, angle} axis / angle values with shape (4,)</span>
<span class="sd">            or (Nmatrices, 4)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ang</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">rot2wxyz</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span> <span class="n">quick</span><span class="o">=</span><span class="n">quick</span><span class="p">,</span> <span class="n">bad_matrix</span><span class="o">=</span><span class="n">bad_matrix</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">axang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">ax</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">axang</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax</span>
    <span class="n">axang</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ang</span>
    <span class="k">return</span> <span class="n">axang</span></div>

<div class="viewcode-block" id="wxyz2quat"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.wxyz2quat">[docs]</a><span class="k">def</span> <span class="nf">wxyz2quat</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;(angle, axis) representation -&gt; quaternion</span>

<span class="sd">    Args:</span>
<span class="sd">        angle (sequence): angle(s) of rotation(s) with</span>
<span class="sd">            shape (), (1,), or (Nmatrices)</span>
<span class="sd">        vector (sequence): 3d vector(s) that is (are) axis of rotation(s)</span>
<span class="sd">            with shape (3,) or (Nmatrices, 3)</span>
<span class="sd">        unit (str): unit of angle, one of (&#39;deg&#39;, &#39;rad&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: quaternions with dtype quaternion and shape</span>
<span class="sd">            (Nmatrices,) or (); or with dtype numpy.double and shape</span>
<span class="sd">            (Nmatrices, 4) or (4)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

    <span class="n">single_val</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">vector</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="n">angle</span> <span class="o">=</span> <span class="n">angle</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">vector</span> <span class="o">=</span> <span class="n">vector</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="n">half_theta_rad</span> <span class="o">=</span> <span class="n">convert_angle</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="s1">&#39;rad&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">half_theta_rad</span><span class="p">),</span> <span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

    <span class="n">q</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">half_theta_rad</span><span class="p">)</span>
    <span class="n">q</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">half_theta_rad</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">vector</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s1">&#39;quaternion&#39;</span><span class="p">):</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;quaternion&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">single_val</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">q</span></div>

<div class="viewcode-block" id="axang2quat"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.axang2quat">[docs]</a><span class="k">def</span> <span class="nf">axang2quat</span><span class="p">(</span><span class="n">axang</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;axis-angle representation -&gt; quaternion</span>

<span class="sd">    Args:</span>
<span class="sd">        axang (ndarray): axis(es) / angle(s) of rotation(s) put</span>
<span class="sd">            together like {x, y, z, angle}; shape should be (4,), or</span>
<span class="sd">            (Nmatrices, 4)</span>
<span class="sd">        unit (str): unit of angle, one of (&#39;deg&#39;, &#39;rad&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: quaternions with dtype quaternion and shape</span>
<span class="sd">            (Nmatrices,) or (); or with dtype numpy.double and shape</span>
<span class="sd">            (Nmatrices, 4) or (4)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">axang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">axang</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">axang</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">axang</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">wxyz2quat</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span></div>

<div class="viewcode-block" id="quat2wxyz"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.quat2wxyz">[docs]</a><span class="k">def</span> <span class="nf">quat2wxyz</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;quaternion -&gt; (angle, axis) representation</span>

<span class="sd">    Args:</span>
<span class="sd">        q (ndarray): quaternions with dtype quaternion and shape</span>
<span class="sd">            (Nmatrices,) or (); or with dtype numpy.double and shape</span>
<span class="sd">            (Nmatrices, 4) or (4)</span>
<span class="sd">        unit (str): unit of angle in results, one of (&#39;deg&#39;, &#39;rad&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        (w, xyz): ``w`` is rotation angle with shape () or (Nmatrices),</span>
<span class="sd">            and ``xyz`` are normalized rotation axes with shape (3,)</span>
<span class="sd">            or (Nmatrices, 3)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s1">&#39;quaternion&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">q</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;quaternion&#39;</span><span class="p">:</span>
        <span class="n">single_val</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">()</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">single_val</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="n">wxyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

    <span class="c1"># normalize quats</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

    <span class="n">vec_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">q</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">wxyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">vec_norm</span><span class="p">,</span> <span class="n">q</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">wxyz</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">/</span> <span class="n">vec_norm</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">vec_norm</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">wxyz</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>

    <span class="n">wxyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_angles</span><span class="p">(</span><span class="n">wxyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;rad&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">single_val</span><span class="p">:</span>
        <span class="n">wxyz</span> <span class="o">=</span> <span class="n">wxyz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">wxyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">wxyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span></div>

<div class="viewcode-block" id="quat2axang"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.quat2axang">[docs]</a><span class="k">def</span> <span class="nf">quat2axang</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;quaternion -&gt; axis-angle representation</span>

<span class="sd">    Args:</span>
<span class="sd">        q (ndarray): quaternions with dtype quaternion and shape</span>
<span class="sd">            (Nmatrices,) or (); or with dtype numpy.double and shape</span>
<span class="sd">            (Nmatrices, 4) or (4)</span>
<span class="sd">        unit (str): unit of angle in results, one of (&#39;deg&#39;, &#39;rad&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        (ndarray): {x, y, z, angle} axis / angle values with shape (4,)</span>
<span class="sd">            or (Nmatrices, 4)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ang</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">quat2wxyz</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">axang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">ax</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">axang</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax</span>
    <span class="n">axang</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ang</span>
    <span class="k">return</span> <span class="n">axang</span></div>

<div class="viewcode-block" id="angle_between"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.angle_between">[docs]</a><span class="k">def</span> <span class="nf">angle_between</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get angle(s) between two (sets of) vectors</span>

<span class="sd">    Args:</span>
<span class="sd">        a (sequence): first vector, shape [Ndim] or [Nvectors, Ndim]</span>
<span class="sd">        b (sequence): second vector, shape [Ndim] or [Nvectors, Ndim]</span>
<span class="sd">        unit (str): unit of result, one of (&#39;deg&#39;, &#39;rad&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        float or ndarray: angle(s)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">single_val</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

    <span class="n">a_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">b_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">normdot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">a_norm</span> <span class="o">*</span> <span class="n">b_norm</span><span class="p">)</span>
    <span class="n">angle_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">normdot</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">single_val</span><span class="p">:</span>
        <span class="n">angle_rad</span> <span class="o">=</span> <span class="n">angle_rad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">convert_angle</span><span class="p">(</span><span class="n">angle_rad</span><span class="p">,</span> <span class="s1">&#39;rad&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span></div>

<div class="viewcode-block" id="a2b_rot"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.a2b_rot">[docs]</a><span class="k">def</span> <span class="nf">a2b_rot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">roll</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">,</span> <span class="n">new_x</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make a matrix that rotates vector a to vector b</span>

<span class="sd">    Args:</span>
<span class="sd">        a (ndarray): starting vector with shape [Ndim]</span>
<span class="sd">            or [Nvectors, Ndim]</span>
<span class="sd">        b (ndarray): destination vector with shape [Ndim]</span>
<span class="sd">            or [Nvectors, Ndim]</span>
<span class="sd">        roll (float): angle of roll around the b vector</span>
<span class="sd">        unit (str): unit of roll, one of (&#39;deg&#39;, &#39;rad&#39;)</span>
<span class="sd">        new_x (ndarray): If given, then roll is set such that</span>
<span class="sd">            the `x` axis (phi = 0) new_x is projected in the plane</span>
<span class="sd">            perpendicular to origin-p1</span>

<span class="sd">    Returns:</span>
<span class="sd">        ndarray: orthonormal rotation matrix with shape [Ndim, Ndim]</span>
<span class="sd">            or [Nvectors, Ndim, Ndim]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">roll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">roll</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

    <span class="n">single_val</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">roll</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">roll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">roll</span><span class="p">)</span>

    <span class="n">a</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">theta_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">null_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">null_mask</span><span class="p">):</span>
        <span class="n">axis</span><span class="p">[</span><span class="n">null_mask</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">null_mask</span><span class="p">,</span> <span class="p">:],</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">null_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">null_mask</span><span class="p">):</span>
            <span class="n">axis</span><span class="p">[</span><span class="n">null_mask</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">null_mask</span><span class="p">,</span> <span class="p">:],</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">R</span> <span class="o">=</span> <span class="n">wxyz2rot</span><span class="p">(</span><span class="n">theta_rad</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>

    <span class="c1"># optionally set roll using a desired orientation for the x-axis</span>
    <span class="k">if</span> <span class="n">new_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">roll</span> <span class="o">==</span> <span class="mf">0.0</span>
        <span class="n">new_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">new_x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">new_x</span> <span class="o">=</span> <span class="n">new_x</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">new_x</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span>
        <span class="n">new_x_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">new_x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">roll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">new_x</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
        <span class="n">no_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">new_x_norm</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">roll</span><span class="p">[</span><span class="n">no_norm</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="o">~</span><span class="n">no_norm</span><span class="p">):</span>
            <span class="n">current_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mij,mj-&gt;mi&#39;</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
            <span class="n">new_x</span> <span class="o">/=</span> <span class="n">new_x_norm</span>
            <span class="n">current_x</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">current_x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
            <span class="n">s_roll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">current_x</span><span class="p">,</span> <span class="n">new_x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">c_roll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">current_x</span> <span class="o">*</span> <span class="n">new_x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">roll</span><span class="p">[</span><span class="o">~</span><span class="n">no_norm</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">s_roll</span><span class="p">,</span> <span class="n">c_roll</span><span class="p">)</span>
            <span class="n">roll</span><span class="p">[</span><span class="o">~</span><span class="n">no_norm</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_angle</span><span class="p">(</span><span class="n">roll</span><span class="p">[</span><span class="o">~</span><span class="n">no_norm</span><span class="p">],</span> <span class="s1">&#39;rad&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
            <span class="n">roll</span><span class="p">[</span><span class="o">~</span><span class="n">no_norm</span><span class="p">]</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">current_x</span><span class="p">,</span> <span class="n">new_x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                             <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">roll</span><span class="p">):</span>
        <span class="n">roll_rad</span> <span class="o">=</span> <span class="n">convert_angle</span><span class="p">(</span><span class="n">roll</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="s1">&#39;rad&#39;</span><span class="p">)</span>
        <span class="n">R_roll</span> <span class="o">=</span> <span class="n">wxyz2rot</span><span class="p">(</span><span class="n">roll_rad</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">R_roll</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mik,mkj-&gt;mij&#39;</span><span class="p">,</span> <span class="n">R_roll</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">single_val</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">R</span></div>

<div class="viewcode-block" id="symbolic_e_dcm"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.symbolic_e_dcm">[docs]</a><span class="k">def</span> <span class="nf">symbolic_e_dcm</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make elementary matrix that rotate axes, not vectors (sympy)&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">sympy</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">angle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">rot_axis1</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">rot_axis2</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">rot_axis3</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognized axis: &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">axis</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="symbolic_e_rot"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.symbolic_e_rot">[docs]</a><span class="k">def</span> <span class="nf">symbolic_e_rot</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make elementary matrix that rotate vectors, not the axes (sympy)&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">symbolic_e_dcm</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">)</span><span class="o">.</span><span class="n">T</span></div>

<div class="viewcode-block" id="symbolic_rot"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.symbolic_rot">[docs]</a><span class="k">def</span> <span class="nf">symbolic_rot</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="s1">&#39;zyx&#39;</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make a symbolic rotation matrix (sympy)&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">sympy</span>
    <span class="k">if</span> <span class="n">angles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="n">sympy</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">)]</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="n">angle</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">angles</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">R</span> <span class="o">*</span> <span class="n">symbolic_e_rot</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">R</span></div>

<div class="viewcode-block" id="symbolic_dcm"><a class="viewcode-back" href="../../api/viscid.rotation.html#viscid.symbolic_dcm">[docs]</a><span class="k">def</span> <span class="nf">symbolic_dcm</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="s1">&#39;zyx&#39;</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make a symbolic direction cosine matrix (sympy)&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">sympy</span>
    <span class="k">if</span> <span class="n">angles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="n">sympy</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">)]</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="n">angle</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">angles</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">R</span> <span class="o">*</span> <span class="n">symbolic_e_dcm</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">R</span></div>

<span class="c1">###########</span>
<span class="c1">## Aliases</span>
<span class="c1">###########</span>

<span class="n">convert_angles</span> <span class="o">=</span> <span class="n">convert_angle</span>

<span class="n">angles2rot</span> <span class="o">=</span> <span class="n">angle2rot</span>
<span class="n">angles2dcm</span> <span class="o">=</span> <span class="n">angle2dcm</span>
<span class="n">rot2angles</span> <span class="o">=</span> <span class="n">rot2angle</span>
<span class="n">dcm2angles</span> <span class="o">=</span> <span class="n">dcm2angle</span>

<span class="c1"># The Matlab Robotics System Toolbox uses &quot;rotm&quot; for &quot;rotation matrix&quot; (rot),</span>
<span class="c1"># and &quot;axang&quot; for &quot;axis-angle&quot; (wxyz),</span>

<span class="n">eul2rotm</span> <span class="o">=</span> <span class="n">eul2rot</span>
<span class="n">angle2rotm</span> <span class="o">=</span> <span class="n">angle2rot</span>
<span class="n">angles2rotm</span> <span class="o">=</span> <span class="n">angles2rot</span>

<span class="n">rotm2eul</span> <span class="o">=</span> <span class="n">rot2eul</span>
<span class="n">rotm2angle</span> <span class="o">=</span> <span class="n">rot2angle</span>
<span class="n">rotm2angles</span> <span class="o">=</span> <span class="n">rot2angle</span>

<span class="n">rotm2quat</span> <span class="o">=</span> <span class="n">rot2quat</span>
<span class="n">quat2rotm</span> <span class="o">=</span> <span class="n">quat2rot</span>

<span class="n">a2b_rotm</span> <span class="o">=</span> <span class="n">a2b_rot</span>

<span class="n">axang2rotm</span> <span class="o">=</span> <span class="n">axang2rot</span>
<span class="n">rotm2axang</span> <span class="o">=</span> <span class="n">rot2axang</span>

<span class="n">wxyz2rotm</span> <span class="o">=</span> <span class="n">wxyz2rot</span>
<span class="n">rotm2wxyz</span> <span class="o">=</span> <span class="n">rot2wxyz</span>

<span class="c1">########</span>
<span class="c1"># Tests</span>
<span class="c1">########</span>

<span class="k">def</span> <span class="nf">_print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
    <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_check_return_shapes</span><span class="p">():</span>
    <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;Checking return shapes&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">angle_between</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">()</span>
    <span class="k">assert</span> <span class="n">angle_between</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
    <span class="k">assert</span> <span class="n">angle_between</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
                         <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)</span>

    <span class="k">assert</span> <span class="n">angle2rot</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">angle2rot</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">angle2rot</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span>
                      <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">angle2dcm</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">angle2dcm</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">angle2dcm</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span>
                      <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">eul2rot</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">eul2rot</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">eul2rot</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">eul2dcm</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">eul2dcm</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">eul2dcm</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">rot2angle</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
    <span class="k">assert</span> <span class="n">rot2angle</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">rot2angle</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">rot2eul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
    <span class="k">assert</span> <span class="n">rot2eul</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">rot2eul</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">dcm2angle</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
    <span class="k">assert</span> <span class="n">dcm2angle</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">dcm2angle</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">dcm2eul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
    <span class="k">assert</span> <span class="n">dcm2eul</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">dcm2eul</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">rotm2quat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)</span>
    <span class="k">assert</span> <span class="n">rotm2quat</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">rotm2quat</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">dcm2quat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)</span>
    <span class="k">assert</span> <span class="n">dcm2quat</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">dcm2quat</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">quat2rotm</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">quat2rotm</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">quat2rotm</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">quat2dcm</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">quat2dcm</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">quat2dcm</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">a2b_rot</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">a2b_rot</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">a2b_rot</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
                   <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">rotmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">rotmul</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">rotmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">rotmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">rotate</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
    <span class="k">assert</span> <span class="n">rotate</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">rotate</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">rotate</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">rotate</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">quatmul</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)</span>
    <span class="k">assert</span> <span class="n">quatmul</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">quatmul</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">quat_rotate</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
    <span class="k">assert</span> <span class="n">quat_rotate</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">quat_rotate</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">quat_rotate</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">quat_rotate</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">wxyz2rot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wxyz2rot</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wxyz2rot</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">],</span>
                    <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">axang2rot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">axang2rot</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">axang2rot</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">rot2wxyz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">()</span>
    <span class="k">assert</span> <span class="n">rot2wxyz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
    <span class="k">assert</span> <span class="n">rot2wxyz</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
    <span class="k">assert</span> <span class="n">rot2wxyz</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)])[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">rot2wxyz</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)</span>
    <span class="k">assert</span> <span class="n">rot2wxyz</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)])[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">rot2axang</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)</span>
    <span class="k">assert</span> <span class="n">rot2axang</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">rot2axang</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">wxyz2quat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)</span>
    <span class="k">assert</span> <span class="n">wxyz2quat</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">wxyz2quat</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">],</span>
                    <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">axang2quat</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)</span>
    <span class="k">assert</span> <span class="n">axang2quat</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">axang2quat</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">quat2wxyz</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">()</span>
    <span class="k">assert</span> <span class="n">quat2wxyz</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
    <span class="k">assert</span> <span class="n">quat2wxyz</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
    <span class="k">assert</span> <span class="n">quat2wxyz</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">quat2wxyz</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)</span>
    <span class="k">assert</span> <span class="n">quat2wxyz</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">quat2axang</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)</span>
    <span class="k">assert</span> <span class="n">quat2axang</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">quat2axang</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">_check_angle2matrix</span><span class="p">():</span>
    <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;Checking angle2matrix&quot;</span><span class="p">)</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,j-&gt;i&#39;</span><span class="p">,</span>
                                 <span class="n">angle2rotm</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;zyx&#39;</span><span class="p">),</span>
                                 <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,j-&gt;i&#39;</span><span class="p">,</span>
                                 <span class="n">angle2dcm</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;zyx&#39;</span><span class="p">),</span>
                                 <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,j-&gt;i&#39;</span><span class="p">,</span>
                                 <span class="n">eul2rotm</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;zyx&#39;</span><span class="p">),</span>
                                 <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,j-&gt;i&#39;</span><span class="p">,</span>
                                 <span class="n">eul2dcm</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;zyx&#39;</span><span class="p">),</span>
                                 <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">fn</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">((</span><span class="n">angle2dcm</span><span class="p">,</span> <span class="n">eul2rotm</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;angle2dcm.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;eul2rotm.csv&#39;</span><span class="p">)):</span>
        <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;Checking angle2dcm&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">{0}</span><span class="s2">&#39; does not exist, skipping test</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;    (it can be generated using Viscid/scratch/gen_rotations.m)&quot;</span>
                   <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;Pandas not installed, skipping test&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="n">unique_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())]</span>

        <span class="c1"># nrows = int(df.shape[0] // len(unique_order))</span>
        <span class="n">orders</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;order&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;U3&#39;</span><span class="p">)</span>
        <span class="n">matlab_angles</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;ang0&#39;</span><span class="p">:</span><span class="s1">&#39;ang2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;f8&#39;</span><span class="p">)</span>
        <span class="n">matlab_dcms</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;R00&#39;</span><span class="p">:</span><span class="s1">&#39;R22&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;f8&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_order</span><span class="p">):</span>
            <span class="n">_print</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="s1">&#39;... &#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">zyx_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">orders</span> <span class="o">==</span> <span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">mlb_angs</span> <span class="o">=</span> <span class="n">matlab_angles</span><span class="p">[</span><span class="n">zyx_slice</span><span class="p">]</span>
            <span class="n">mlb_mats</span> <span class="o">=</span> <span class="n">matlab_dcms</span><span class="p">[</span><span class="n">zyx_slice</span><span class="p">]</span>
            <span class="c1"># mlb_xangs = matlab_xangles[zyx_slice]</span>

            <span class="n">py_mats</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">mlb_angs</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>

            <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mlb_angs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">py_mats</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mlb_mats</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">atol</span><span class="o">=</span><span class="mf">4e-12</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">4e-12</span><span class="p">):</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">ret</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;Failure (&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;    angles:&quot;</span><span class="p">,</span> <span class="n">mlb_angs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;    matlab dcm:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mlb_mats</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;    python dcm:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">py_mats</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Success!&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">_check_matrix2angle</span><span class="p">(</span><span class="n">quick</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">quick</span><span class="p">:</span>
        <span class="n">orders</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;zyx&#39;</span><span class="p">,</span> <span class="s1">&#39;zyz&#39;</span><span class="p">)</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1e-3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">([</span><span class="o">-</span><span class="mi">360</span><span class="p">,</span> <span class="o">-</span><span class="mi">270</span><span class="p">,</span> <span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">135</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                               <span class="mi">30</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">270</span><span class="p">,</span> <span class="mi">360</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">orders</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;zyx&#39;</span><span class="p">,</span> <span class="s1">&#39;yxz&#39;</span><span class="p">,</span> <span class="s1">&#39;xzy&#39;</span><span class="p">,</span> <span class="s1">&#39;xyz&#39;</span><span class="p">,</span> <span class="s1">&#39;yzx&#39;</span><span class="p">,</span> <span class="s1">&#39;zxy&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;zyz&#39;</span><span class="p">,</span> <span class="s1">&#39;zxz&#39;</span><span class="p">,</span> <span class="s1">&#39;yzy&#39;</span><span class="p">,</span> <span class="s1">&#39;yxy&#39;</span><span class="p">,</span> <span class="s1">&#39;xzx&#39;</span><span class="p">,</span> <span class="s1">&#39;xyx&#39;</span><span class="p">)</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">1e-3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">([</span><span class="o">-</span><span class="mi">360</span><span class="p">,</span> <span class="o">-</span><span class="mi">270</span><span class="p">,</span> <span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">135</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="o">-</span><span class="mi">45</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span>
                               <span class="mi">0</span><span class="p">,</span>
                               <span class="mi">30</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">270</span><span class="p">,</span> <span class="mi">360</span><span class="p">])</span>

    <span class="n">angs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">center</span> <span class="o">+</span> <span class="n">arr</span> <span class="k">for</span> <span class="n">center</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">])</span>
    <span class="n">angs3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">angs</span><span class="p">,</span> <span class="n">angs</span><span class="p">,</span> <span class="n">angs</span><span class="p">))</span>
    <span class="n">angs3</span> <span class="o">=</span> <span class="n">angs3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="n">fwd_funcs</span> <span class="o">=</span> <span class="p">(</span><span class="n">angle2rot</span><span class="p">,</span> <span class="n">angle2dcm</span><span class="p">,</span> <span class="n">eul2rot</span><span class="p">,</span> <span class="n">eul2dcm</span><span class="p">)</span>
    <span class="n">rev_funcs</span> <span class="o">=</span> <span class="p">(</span><span class="n">rot2angle</span><span class="p">,</span> <span class="n">dcm2angle</span><span class="p">,</span> <span class="n">rot2eul</span><span class="p">,</span> <span class="n">dcm2eul</span><span class="p">)</span>
    <span class="n">fwd_funcs</span> <span class="o">=</span> <span class="p">(</span><span class="n">eul2dcm</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">rev_funcs</span> <span class="o">=</span> <span class="p">(</span><span class="n">dcm2eul</span><span class="p">,</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">fn_ang2mat</span><span class="p">,</span> <span class="n">fn_mat2ang</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fwd_funcs</span><span class="p">,</span> <span class="n">rev_funcs</span><span class="p">):</span>
        <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;Checking&quot;</span><span class="p">,</span> <span class="n">fn_mat2ang</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">orders</span><span class="p">:</span>
            <span class="n">_print</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="s1">&#39;... &#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="n">R0</span> <span class="o">=</span> <span class="n">fn_ang2mat</span><span class="p">(</span><span class="n">angs3</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">fn_mat2ang</span><span class="p">(</span><span class="n">R0</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
            <span class="n">R1</span> <span class="o">=</span> <span class="n">fn_ang2mat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>

            <span class="n">matched</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">R0</span><span class="p">,</span> <span class="n">R1</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">)</span>
            <span class="n">matched_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">matched</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># calculate relative difference between R0 and R1, which should</span>
            <span class="c1"># be equal up to round off - but note that the roundoff error</span>
            <span class="c1"># is affected by dividing by small numbers</span>
            <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
                <span class="n">max_R0_R1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">R0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">R1</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">rel_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">R0</span> <span class="o">-</span> <span class="n">R1</span><span class="p">)</span> <span class="o">/</span> <span class="n">max_R0_R1</span>
                <span class="c1"># mask out small numbers (the matrices are ortho-NORMAL,</span>
                <span class="c1"># so small is relative to unity)</span>
                <span class="n">rel_diff</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">R0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">,</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">R1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">matched_mat</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;Success!&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;Failed!  </span><span class="si">{0:.4}% o</span><span class="s2">f matrices mismatched&quot;</span>
                       <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">matched_mat</span><span class="p">)</span> <span class="o">/</span> <span class="n">matched_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;           relative diff; 50%: </span><span class="si">{0:.2g}</span><span class="s2">  90%: </span><span class="si">{1:.2g}</span><span class="s2">  &quot;</span>
                   <span class="s2">&quot;99.9%: </span><span class="si">{2:.2g}</span><span class="s2">  100%: </span><span class="si">{3:.2g}</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">rel_diff</span><span class="p">,</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mf">99.9</span><span class="p">,</span> <span class="mi">100</span><span class="p">])))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">rel_diff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">_print</span><span class="p">()</span>
                <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;    Transform with worst relative difference:&quot;</span><span class="p">)</span>
                <span class="n">_print</span><span class="p">()</span>
                <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;      Original Angles: &quot;</span><span class="p">,</span> <span class="n">angs3</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;      rot2euls:      &quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">_print</span><span class="p">()</span>
                <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;      R0:&quot;</span><span class="p">)</span>
                <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;      &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">R0</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">       &#39;</span><span class="p">))</span>
                <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;      R1:&quot;</span><span class="p">)</span>
                <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;      &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">R1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">       &#39;</span><span class="p">))</span>
                <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;      Relative Difference:&quot;</span><span class="p">)</span>
                <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;      &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rel_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">       &#39;</span><span class="p">))</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">_check_wxyz2rot</span><span class="p">():</span>
    <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;Checking wxyz2rot&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">wxyz2rotm</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
                       <span class="n">eul2rotm</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]))</span>

    <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;axang2rotm.csv&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">mlb_ax</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;ax0&#39;</span><span class="p">:</span><span class="s1">&#39;ax2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
            <span class="n">mlb_ang</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;ang&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
            <span class="n">mlb_rots</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;R00&#39;</span><span class="p">:</span><span class="s1">&#39;R22&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;f8&#39;</span><span class="p">)</span>

            <span class="n">py_mats</span> <span class="o">=</span> <span class="n">wxyz2rot</span><span class="p">(</span><span class="n">mlb_ang</span><span class="p">,</span> <span class="n">mlb_ax</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">py_mats</span><span class="p">,</span> <span class="n">mlb_rots</span><span class="p">)</span>

            <span class="c1"># double check eul2rotm because we can</span>
            <span class="n">mlb_eul</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;eul0&#39;</span><span class="p">:</span><span class="s1">&#39;eul2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;f8&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">mlb_rots</span><span class="p">,</span> <span class="n">eul2rotm</span><span class="p">(</span><span class="n">mlb_eul</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">{0}</span><span class="s2">&#39; does not exist, skipping test</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="s2">&quot;    (it can be generated using Viscid/scratch/gen_rotations.m)&quot;</span>
               <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;Pandas not installed, skipping test&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">_check_rot2wxyz</span><span class="p">():</span>
    <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;Checking rot2wxyz&quot;</span><span class="p">)</span>

    <span class="n">vectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                        <span class="p">])</span>
    <span class="n">ang_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">ang_centers</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vectors</span><span class="p">):</span>
        <span class="n">Rmats</span> <span class="o">=</span> <span class="n">wxyz2rot</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
        <span class="n">new_ang</span><span class="p">,</span> <span class="n">new_ax</span> <span class="o">=</span> <span class="n">rot2wxyz</span><span class="p">(</span><span class="n">Rmats</span><span class="p">)</span>
        <span class="n">new_Rmats</span> <span class="o">=</span> <span class="n">wxyz2rot</span><span class="p">(</span><span class="n">new_ang</span><span class="p">,</span> <span class="n">new_ax</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Rmats</span><span class="p">,</span> <span class="n">new_Rmats</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">2e-8</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">2e-8</span><span class="p">)</span>

    <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">_check_matrix2quat</span><span class="p">(</span><span class="n">quick</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;Checking rotation matrix to quaternion&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">quick</span><span class="p">:</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1e-3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">([</span><span class="o">-</span><span class="mi">360</span><span class="p">,</span> <span class="o">-</span><span class="mi">270</span><span class="p">,</span> <span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">135</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                               <span class="mi">30</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">270</span><span class="p">,</span> <span class="mi">360</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">1e-3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">([</span><span class="o">-</span><span class="mi">360</span><span class="p">,</span> <span class="o">-</span><span class="mi">270</span><span class="p">,</span> <span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">135</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="o">-</span><span class="mi">45</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span>
                               <span class="mi">0</span><span class="p">,</span>
                               <span class="mi">30</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">270</span><span class="p">,</span> <span class="mi">360</span><span class="p">])</span>

    <span class="n">angs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">center</span> <span class="o">+</span> <span class="n">arr</span> <span class="k">for</span> <span class="n">center</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">])</span>
    <span class="n">angs3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">angs</span><span class="p">,</span> <span class="n">angs</span><span class="p">,</span> <span class="n">angs</span><span class="p">))</span>
    <span class="n">angs3</span> <span class="o">=</span> <span class="n">angs3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="n">R</span> <span class="o">=</span> <span class="n">eul2rotm</span><span class="p">(</span><span class="n">angs3</span><span class="p">)</span>

    <span class="n">q_rotm</span> <span class="o">=</span> <span class="n">rotm2quat</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
    <span class="n">R2</span> <span class="o">=</span> <span class="n">quat2rotm</span><span class="p">(</span><span class="n">q_rotm</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">R2</span><span class="p">)</span>

    <span class="n">q_dcm</span> <span class="o">=</span> <span class="n">dcm2quat</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
    <span class="n">R2</span> <span class="o">=</span> <span class="n">quat2dcm</span><span class="p">(</span><span class="n">q_dcm</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">R2</span><span class="p">)</span>

    <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">_check_quat2matrix</span><span class="p">():</span>
    <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;Checking quaternion to rotation matrix&quot;</span><span class="p">)</span>

    <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;rotm2quat.csv&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">mlb_rots</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;R00&#39;</span><span class="p">:</span><span class="s1">&#39;R22&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;f8&#39;</span><span class="p">)</span>
            <span class="n">mlb_q_rotm</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;q0_rotm&#39;</span><span class="p">:</span><span class="s1">&#39;q3_rotm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;f8&#39;</span><span class="p">)</span>
            <span class="n">mlb_q_dcm</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;q0_dcm&#39;</span><span class="p">:</span><span class="s1">&#39;q3_dcm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;f8&#39;</span><span class="p">)</span>

            <span class="n">py_rotm</span> <span class="o">=</span> <span class="n">quat2rotm</span><span class="p">(</span><span class="n">mlb_q_rotm</span><span class="p">)</span>
            <span class="c1"># valid = np.all(np.all(np.isclose(mlb_rots, py_rotm), axis=2), axis=1)</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">mlb_rots</span><span class="p">,</span> <span class="n">py_rotm</span><span class="p">)</span>

            <span class="n">py_dcm</span> <span class="o">=</span> <span class="n">quat2dcm</span><span class="p">(</span><span class="n">mlb_q_dcm</span><span class="p">)</span>
            <span class="c1"># valid = np.all(np.all(np.isclose(mlb_rots, py_dcm), axis=2), axis=1)</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">mlb_rots</span><span class="p">,</span> <span class="n">py_dcm</span><span class="p">)</span>

            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">{0}</span><span class="s2">&#39; does not exist, skipping test</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="s2">&quot;    (it can be generated using Viscid/scratch/gen_rotations.m)&quot;</span>
               <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;Pandas not installed, skipping test&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">_check_quat2axang</span><span class="p">(</span><span class="n">quick</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;Checking quat &lt;-&gt; axis/angle representations&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">quick</span><span class="p">:</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1e-3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">([</span><span class="o">-</span><span class="mi">360</span><span class="p">,</span> <span class="o">-</span><span class="mi">270</span><span class="p">,</span> <span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">135</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                               <span class="mi">30</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">270</span><span class="p">,</span> <span class="mi">360</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">1e-3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">([</span><span class="o">-</span><span class="mi">360</span><span class="p">,</span> <span class="o">-</span><span class="mi">270</span><span class="p">,</span> <span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">135</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="o">-</span><span class="mi">45</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span>
                               <span class="mi">0</span><span class="p">,</span>
                               <span class="mi">30</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">270</span><span class="p">,</span> <span class="mi">360</span><span class="p">])</span>

    <span class="n">angs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">center</span> <span class="o">+</span> <span class="n">arr</span> <span class="k">for</span> <span class="n">center</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">])</span>
    <span class="n">angs3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">angs</span><span class="p">,</span> <span class="n">angs</span><span class="p">,</span> <span class="n">angs</span><span class="p">))</span>
    <span class="n">angs3</span> <span class="o">=</span> <span class="n">angs3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="n">R0</span> <span class="o">=</span> <span class="n">eul2rotm</span><span class="p">(</span><span class="n">angs3</span><span class="p">)</span>
    <span class="n">axang0</span> <span class="o">=</span> <span class="n">rotm2axang</span><span class="p">(</span><span class="n">R0</span><span class="p">)</span>
    <span class="n">q1</span> <span class="o">=</span> <span class="n">axang2quat</span><span class="p">(</span><span class="n">axang0</span><span class="p">)</span>
    <span class="n">axang1</span> <span class="o">=</span> <span class="n">quat2axang</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">R0</span><span class="p">,</span> <span class="n">quat2rotm</span><span class="p">(</span><span class="n">q1</span><span class="p">),</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">axang2rotm</span><span class="p">(</span><span class="n">axang0</span><span class="p">),</span> <span class="n">quat2rotm</span><span class="p">(</span><span class="n">q1</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">axang2rotm</span><span class="p">(</span><span class="n">axang0</span><span class="p">),</span> <span class="n">axang2rotm</span><span class="p">(</span><span class="n">axang1</span><span class="p">),</span>
                       <span class="n">atol</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">)</span>

    <span class="n">R0</span> <span class="o">=</span> <span class="n">eul2rotm</span><span class="p">(</span><span class="n">angs3</span><span class="p">)</span>
    <span class="n">w0</span><span class="p">,</span> <span class="n">xyz0</span> <span class="o">=</span> <span class="n">rotm2wxyz</span><span class="p">(</span><span class="n">R0</span><span class="p">)</span>
    <span class="n">q1</span> <span class="o">=</span> <span class="n">wxyz2quat</span><span class="p">(</span><span class="n">w0</span><span class="p">,</span> <span class="n">xyz0</span><span class="p">)</span>
    <span class="n">w1</span><span class="p">,</span> <span class="n">xyz1</span> <span class="o">=</span> <span class="n">quat2wxyz</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">R0</span><span class="p">,</span> <span class="n">quat2rotm</span><span class="p">(</span><span class="n">q1</span><span class="p">),</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">wxyz2rotm</span><span class="p">(</span><span class="n">w0</span><span class="p">,</span> <span class="n">xyz0</span><span class="p">),</span> <span class="n">quat2rotm</span><span class="p">(</span><span class="n">q1</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">wxyz2rotm</span><span class="p">(</span><span class="n">w0</span><span class="p">,</span> <span class="n">xyz0</span><span class="p">),</span> <span class="n">wxyz2rotm</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">xyz1</span><span class="p">),</span>
                       <span class="n">atol</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">)</span>

    <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">_check_angle_between</span><span class="p">():</span>
    <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;Checking angle_between&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">angle_between</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">angle_between</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">_check_a2b_rot</span><span class="p">():</span>
    <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;Checking a2b_rot&quot;</span><span class="p">)</span>

    <span class="n">vectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">])</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">33</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vectors</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vectors</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mij,j-&gt;mi&#39;</span><span class="p">,</span>
                                         <span class="n">a2b_rot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">roll</span><span class="o">=</span><span class="n">angles</span><span class="p">),</span>
                                         <span class="n">a</span><span class="p">),</span>
                               <span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">_check_quatmul</span><span class="p">():</span>
    <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;Checking quatmul&quot;</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">eul2rotm</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">],</span>
                  <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                  <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">3</span><span class="p">],</span>
                  <span class="p">])</span>
    <span class="n">vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
                     <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span>
                     <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span>
                     <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span>
                     <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span>
                     <span class="p">])</span>

    <span class="k">def</span> <span class="nf">_run_test</span><span class="p">():</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">rotm2quat</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">vec</span> <span class="ow">in</span> <span class="n">vecs</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="o">*</span><span class="n">R</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">quat_rotate</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-14</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-14</span><span class="p">)</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">vecs</span><span class="p">,</span> <span class="o">*</span><span class="n">R</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">quat_rotate</span><span class="p">(</span><span class="n">vecs</span><span class="p">,</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-14</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-14</span><span class="p">)</span>

    <span class="n">_run_test</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">quaternion</span>
        <span class="n">_run_test</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;quaternion library not found, skipping test&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">_check_all</span><span class="p">(</span><span class="n">quick</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">_check_return_shapes</span><span class="p">()</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">_check_wxyz2rot</span><span class="p">()</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">_check_rot2wxyz</span><span class="p">()</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">_check_angle_between</span><span class="p">()</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">_check_a2b_rot</span><span class="p">()</span>

    <span class="n">ret</span> <span class="o">+=</span> <span class="n">_check_matrix2quat</span><span class="p">(</span><span class="n">quick</span><span class="o">=</span><span class="n">quick</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">_check_quat2matrix</span><span class="p">()</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">_check_quat2axang</span><span class="p">(</span><span class="n">quick</span><span class="o">=</span><span class="n">quick</span><span class="p">)</span>

    <span class="n">ret</span> <span class="o">+=</span> <span class="n">_check_quatmul</span><span class="p">()</span>

    <span class="n">ret</span> <span class="o">+=</span> <span class="n">_check_angle2matrix</span><span class="p">()</span>
    <span class="n">ret</span> <span class="o">+=</span> <span class="n">_check_matrix2angle</span><span class="p">(</span><span class="n">quick</span><span class="o">=</span><span class="n">quick</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">_main</span><span class="p">():</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">_check_all</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;All tests succeeded!&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_print</span><span class="p">(</span><span class="s2">&quot;Some tests failed&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">_main</span><span class="p">())</span>

<span class="c1">##</span>
<span class="c1">## EOF</span>
<span class="c1">##</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2018, Kristofor Maynard.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.<br/>
    </p>
  </div>
</footer>
  </body>
</html>