
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>viscid.sliceutil &#8212; Viscid 0.99.9.dev0 documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<link rel="icon" href="../../_static/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="../../_static/favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon-precomposed" href="../../_static/Vicon_128.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="stylesheet" href="../../_static/my-css.css" type="text/css" />

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          Viscid</a>
        <span class="navbar-text navbar-version pull-left"><b>0.99.9.dev0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
    <li class="dropdown">
      <a role="button"
         id="dLabelNavLinxToc"
         data-toggle="dropdown"
         data-target="#"
         href="#">Tutorial <b class="caret"></b></a>
      <ul class="dropdown-menu navlinktoc"
          role="menu">
          <li class="toctree-l1">
            <a class="reference internal", href="../../installation.html">Installation</a>
          </li>
          <li class="toctree-l1">
            <a class="reference internal", href="../../tutorial/creating_fields.html">Creating Fields</a>
          </li>
          <li class="toctree-l1">
            <a class="reference internal", href="../../tutorial/slicing.html">Slicing Fields</a>
          </li>
          <li class="toctree-l1">
            <a class="reference internal", href="../../tutorial/plotting_scalars.html">Plotting Scalars</a>
          </li>
          <li class="toctree-l1">
            <a class="reference internal", href="../../tutorial/plotting_vectors.html">Plotting Vectors</a>
          </li>
          <li class="toctree-l1">
            <a class="reference internal", href="../../tutorial/mayavi.html">3D Plots (Mayavi)</a>
          </li>
          <li class="toctree-l1">
            <a class="reference internal", href="../../tutorial/openggcm.html">OpenGGCM Specific</a>
          </li>
          <li class="toctree-l1">
            <a class="reference internal", href="../../tutorial/ionosphere.html">Ionosphere</a>
          </li>
          <li class="toctree-l1">
            <a class="reference internal", href="../../tutorial/stream_and_interp.html">Streamline and Interpolation</a>
          </li>
          <li class="toctree-l1">
            <a class="reference internal", href="../../tutorial/magnetic_topology.html">Magnetic Topology</a>
          </li>
          <li class="toctree-l1">
            <a class="reference internal", href="../../tutorial/magnetopause.html">Magnetopause</a>
          </li>
          <li class="toctree-l1">
            <a class="reference internal", href="../../tutorial/quasi_potential.html">Quasi Potential</a>
          </li>
      </ul>
    </li>

            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../changes.html">ChangeLog</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../philosophy.html">Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../indexing.html">Indexing Fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/index.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tips_and_tricks.html">Tips &amp; Tricks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../functions.html">Useful Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plot_options.html">Plot Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mpl_style_gallery.html">Matplotlib Style Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../custom_behavior.html">Custom Behavior (rc file)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev_guide.html">Developerâ€™s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extending_readers.html">Extending Readers</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/viscid.html">API</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <h1>Source code for viscid.sliceutil</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;Handle slice by index / location (value)&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">count</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">viscid</span> <span class="k">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">viscid.compat</span> <span class="k">import</span> <span class="n">izip</span><span class="p">,</span> <span class="n">string_types</span>
<span class="kn">from</span> <span class="nn">viscid.npdatetime</span> <span class="k">import</span> <span class="p">(</span><span class="n">is_datetime_like</span><span class="p">,</span> <span class="n">is_timedelta_like</span><span class="p">,</span>
                               <span class="n">as_datetime64</span><span class="p">,</span> <span class="n">as_timedelta64</span><span class="p">,</span> <span class="n">time_diff</span><span class="p">)</span>


<span class="n">_R_MULTILEVEL_BRACKETS</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\[[^\]]*\[[^\]]*\]&quot;</span>
<span class="n">_R_IN_BRACKS</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\[[^\[\]]+\]&quot;</span>
<span class="n">_R_DATE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;[0-9]</span><span class="si">{4}</span><span class="s2">-[0-9]</span><span class="si">{2}</span><span class="s2">-[0-9]</span><span class="si">{2}</span><span class="s2">&quot;</span>
<span class="n">_R_TIME02</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;[0-9]</span><span class="si">{2}</span><span class="s2">(?::[0-9]</span><span class="si">{2}</span><span class="s2">){0,2}(?:\.[0-9]+)?&quot;</span>
<span class="n">_R_TIME12</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;[0-9]</span><span class="si">{2}</span><span class="s2">(?::[0-9]</span><span class="si">{2}</span><span class="s2">){1,2}(?:\.[0-9]+)?&quot;</span>
<span class="n">RE_DTIME_GROUP</span> <span class="o">=</span> <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?:[utUT]*</span><span class="si">{date}</span><span class="s2">(?:[tT]</span><span class="si">{time02}</span><span class="s2">)?|[utUT]+</span><span class="si">{time02}</span><span class="s2">|&quot;</span>
                  <span class="sa">r</span><span class="s2">&quot;[utUT]*</span><span class="si">{time12}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">_R_DATE</span><span class="p">,</span> <span class="n">time02</span><span class="o">=</span><span class="n">_R_TIME02</span><span class="p">,</span>
                                             <span class="n">time12</span><span class="o">=</span><span class="n">_R_TIME12</span><span class="p">))</span>
<span class="n">_R_DTIME</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\s*</span><span class="si">{0}</span><span class="s2">\s*)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">RE_DTIME_GROUP</span><span class="p">))</span>
<span class="c1"># _R_DTIME_SLC is _R_DTIME that must begin with r&#39;[ut]+&#39;</span>
<span class="n">RE_DTIME_SLC_GROUP</span> <span class="o">=</span> <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[utUT]+(?:</span><span class="si">{date}</span><span class="s2">(?:[tT]</span><span class="si">{time}</span><span class="s2">)?|</span><span class="si">{time}</span><span class="s2">)&quot;</span>
                      <span class="sa">r</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">_R_DATE</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">_R_TIME02</span><span class="p">))</span>
<span class="n">_R_DTIME_SLC</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\s*</span><span class="si">{0}</span><span class="s2">\s*)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">RE_DTIME_SLC_GROUP</span><span class="p">))</span>

<span class="n">_emit_deprecated_float_warning</span> <span class="o">=</span> <span class="kc">True</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;prune_comp_sel&quot;</span><span class="p">,</span> <span class="s2">&quot;raw_sel2sel_list&quot;</span><span class="p">,</span> <span class="s2">&quot;fill_nd_sel_list&quot;</span><span class="p">,</span>
           <span class="s2">&quot;standardize_sel_list&quot;</span><span class="p">,</span> <span class="s2">&quot;standardize_sel&quot;</span><span class="p">,</span> <span class="s2">&quot;standardize_value&quot;</span><span class="p">,</span>
           <span class="s2">&quot;std_sel_list2index&quot;</span><span class="p">,</span> <span class="s2">&quot;std_sel2index&quot;</span><span class="p">,</span>
           <span class="s2">&quot;sel_list2values&quot;</span><span class="p">,</span> <span class="s2">&quot;sel2values&quot;</span><span class="p">,</span> <span class="s2">&quot;selection2values&quot;</span><span class="p">,</span>
           <span class="s2">&quot;make_fwd_slice&quot;</span><span class="p">,</span> <span class="s2">&quot;all_slices_none&quot;</span>
           <span class="p">]</span>


<div class="viewcode-block" id="prune_comp_sel"><a class="viewcode-back" href="../../api/viscid.sliceutil.html#viscid.prune_comp_sel">[docs]</a><span class="k">def</span> <span class="nf">prune_comp_sel</span><span class="p">(</span><span class="n">sel_list</span><span class="p">,</span> <span class="n">comp_names</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Discover and remove vector component from selection list&quot;&quot;&quot;</span>
    <span class="n">comp_slc</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">comp_idx</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># discover sel_names and rip out any vector-component slices if given</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sel_list</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">comp_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">comp_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Multiple vector component slices given, </span><span class="si">{0}</span><span class="s2">&quot;</span>
                                     <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">sel_list</span><span class="p">)))</span>
                <span class="n">comp_slc</span> <span class="o">=</span> <span class="n">comp_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="n">comp_idx</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="n">comp_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sel_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">comp_idx</span><span class="p">)</span>
        <span class="n">comp_idx</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">sel_list</span><span class="p">,</span> <span class="n">comp_slc</span></div>

<div class="viewcode-block" id="raw_sel2sel_list"><a class="viewcode-back" href="../../api/viscid.sliceutil.html#viscid.raw_sel2sel_list">[docs]</a><span class="k">def</span> <span class="nf">raw_sel2sel_list</span><span class="p">(</span><span class="n">sel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Turn generic selection into something standard we can work with</span>

<span class="sd">    Args:</span>
<span class="sd">        sel (object): some slice selection</span>

<span class="sd">    Returns:</span>
<span class="sd">        (sel_list, input_type): items in sel_list are guarenteed to be</span>
<span class="sd">            of type {slice, int, complex, string, numpy.ndarray}</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: slice-by-array invalid dtype</span>
<span class="sd">        ValueError: slice-by-array not 1D</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># type(None) includes np.newaxis</span>
    <span class="n">valid_types</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">complex</span><span class="p">,</span>
                   <span class="n">np</span><span class="o">.</span><span class="n">complexfloating</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span>
                   <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">Ellipsis</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">sel_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
        <span class="c1"># input_type = &#39;tuple&#39;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="c1"># DANGER, this is different behavior from tuple since sel</span>
        <span class="c1">#         will become an ndarray before we return... maybe</span>
        <span class="c1">#         supply a warning like numpy 1.15 does?</span>
        <span class="n">sel_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">sel</span><span class="p">]</span>
        <span class="c1"># input_type = &#39;list&#39;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">valid_types</span><span class="p">):</span>
        <span class="n">sel_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">sel</span><span class="p">]</span>
        <span class="c1"># input_type = &#39;single-value&#39;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="c1"># mutate commas between brackets (they indicate strings)</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">_R_MULTILEVEL_BRACKETS</span><span class="p">,</span> <span class="n">sel</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Slice-by-array in Viscid is limited to 1D &quot;</span>
                             <span class="s2">&quot;arrays since coordinate arrays become &quot;</span>
                             <span class="s2">&quot;ambiguous otherwise.&quot;</span><span class="p">)</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_R_IN_BRACKS</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;@&quot;</span><span class="p">),</span> <span class="n">sel</span><span class="p">)</span>
        <span class="n">sel_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
        <span class="c1"># put the commas back into the arrays</span>
        <span class="n">sel_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sel_list</span><span class="p">]</span>
        <span class="c1"># input_type = &#39;string&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sel_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">sel</span><span class="p">]</span>
        <span class="c1"># input_type = &#39;other&#39;</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sel_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">valid_types</span> <span class="o">+</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="n">sel_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sel_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">is_valid_dtype</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)</span>
                              <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">complexfloating</span><span class="p">)</span>
                              <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid_dtype</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Slice interpreted as slice-by-array of &quot;</span>
                                     <span class="s2">&quot;object dtype. If you did</span><span class="se">\n</span><span class="s2">not intend to &quot;</span>
                                     <span class="s2">&quot;slice-by-array, then you probably gave &quot;</span>
                                     <span class="s2">&quot;an n-dimensional slice</span><span class="se">\n</span><span class="s2">as a list instead &quot;</span>
                                     <span class="s2">&quot;of a tuple... oops.&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Slice-by-array with invalid dtype &#39;</span><span class="si">{0}</span><span class="s2">&#39; (must &quot;</span>
                                 <span class="s2">&quot;be (int, bool, complex, timedeta64, datetime64).&quot;</span>
                                 <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>

            <span class="n">is_valid_shape</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid_shape</span><span class="p">:</span>
                <span class="c1"># print(&quot;what is s??&quot;, type(s), s.shape, s)</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Slice-by-array in Viscid is limited to 1D &quot;</span>
                                 <span class="s2">&quot;arrays since coordinate arrays become &quot;</span>
                                 <span class="s2">&quot;ambiguous otherwise.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sel_list</span></div>

<div class="viewcode-block" id="fill_nd_sel_list"><a class="viewcode-back" href="../../api/viscid.sliceutil.html#viscid.fill_nd_sel_list">[docs]</a><span class="k">def</span> <span class="nf">fill_nd_sel_list</span><span class="p">(</span><span class="n">sel_list</span><span class="p">,</span> <span class="n">ax_names</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;fully determine a sparsely selected sel_list&quot;&quot;&quot;</span>
    <span class="n">sel_list0</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sel_list</span><span class="p">)</span>

    <span class="n">sel_names</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel_list</span><span class="p">)</span>

    <span class="c1"># discover sel_names</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sel_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">string_types</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;=&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">sel_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sel_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ss</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>

    <span class="c1"># discover which items in sel_list are ellipsis or newaxis</span>
    <span class="n">pre_elip_newax_idxs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">post_elip_newax_idxs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ellipsis_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sel_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">Ellipsis</span><span class="p">,</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">string_types</span><span class="p">)</span>
                                 <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ellipsis&#39;</span><span class="p">,</span> <span class="s1">&#39;...&#39;</span><span class="p">)):</span>
            <span class="n">sel_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">Ellipsis</span>
            <span class="k">if</span> <span class="n">ellipsis_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ellipsis_idx</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Only one ellipsis per slice please, </span><span class="si">{0}</span><span class="s2">&quot;</span>
                                 <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sel_list0</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">string_types</span><span class="p">)</span>
                                         <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                                                                   <span class="s1">&#39;newaxis&#39;</span><span class="p">)):</span>
            <span class="n">sel_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span>
            <span class="k">if</span> <span class="n">ellipsis_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pre_elip_newax_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">post_elip_newax_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">newax_idxs</span> <span class="o">=</span> <span class="n">pre_elip_newax_idxs</span> <span class="o">+</span> <span class="n">post_elip_newax_idxs</span>
    <span class="n">n_newax</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">newax_idxs</span><span class="p">)</span>

    <span class="n">n_named_axes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="kc">None</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">sel_names</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
    <span class="n">n_named_newaxes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="kc">None</span> <span class="k">for</span> <span class="n">sel</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sel_list</span><span class="p">,</span> <span class="n">sel_names</span><span class="p">)</span>
                           <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sel</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>

    <span class="c1"># replace ellipsis with some number of slice(None)</span>
    <span class="k">if</span> <span class="n">ellipsis_idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n_named_axes</span> <span class="o">&gt;</span> <span class="n">n_named_newaxes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Field indexing with Ellipsis can only be used &quot;</span>
                             <span class="s2">&quot;with named axes if those named axes are &quot;</span>
                             <span class="s2">&quot;numpy.newaxis, sel = </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sel_list0</span><span class="p">))</span>
        <span class="n">n_fill</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax_names</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_newax</span> <span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sel_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">ellipsis_idx</span>
        <span class="n">sel_list</span> <span class="o">=</span> <span class="n">sel_list</span><span class="p">[:</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="n">n_fill</span> <span class="o">+</span> <span class="n">sel_list</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="n">sel_names</span> <span class="o">=</span> <span class="n">sel_names</span><span class="p">[:</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_fill</span> <span class="o">+</span> <span class="n">sel_names</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="n">newax_idxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">idx</span> <span class="k">else</span> <span class="n">i</span> <span class="o">+</span> <span class="n">n_fill</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">newax_idxs</span><span class="p">]</span>

    <span class="c1"># now let&#39;s assemble the final full slice list / ax names...</span>
    <span class="n">full_ax_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">full_sel_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">full_newdim_flags</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">remaining_ax_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ax_names</span><span class="p">)</span>
    <span class="n">n_newax_seen</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n_unnamed_newax_seen</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sel</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">count</span><span class="p">(),</span> <span class="n">sel_names</span><span class="p">,</span> <span class="n">sel_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">newax_idxs</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;new-x</span><span class="si">{0:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_unnamed_newax_seen</span><span class="p">)</span>
                <span class="n">n_unnamed_newax_seen</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">n_newax_seen</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">remaining_ax_names</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># named selection</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">newax_idxs</span><span class="p">:</span>
                <span class="n">n_newax_seen</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">full_ax_names</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ax_names</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;New axis duplicates name, </span><span class="si">{0}</span><span class="s2">&quot;</span>
                                     <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sel_list0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># named selection that is not newaxis</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">full_ax_names</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">full_ax_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">full_sel_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Axis &#39;</span><span class="si">{0}</span><span class="s2">&#39; is repeated in slice </span><span class="si">{1}</span><span class="s2">&quot;</span>
                                         <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sel_list0</span><span class="p">))</span>
                    <span class="n">full_ax_names</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
                    <span class="n">full_sel_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sel</span>
                    <span class="n">full_newdim_flags</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">continue</span>  <span class="c1"># &lt;- poor style, sorry</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">n_skipped</span> <span class="o">=</span> <span class="n">remaining_ax_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">full_ax_names</span> <span class="o">+=</span> <span class="n">remaining_ax_names</span><span class="p">[:</span><span class="n">n_skipped</span><span class="p">]</span>
                    <span class="n">full_sel_list</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="n">n_skipped</span>
                    <span class="n">full_newdim_flags</span> <span class="o">+=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_skipped</span>
                    <span class="n">remaining_ax_names</span> <span class="o">=</span> <span class="n">remaining_ax_names</span><span class="p">[</span><span class="n">n_skipped</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>

        <span class="n">full_ax_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">full_sel_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
        <span class="n">full_newdim_flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">newax_idxs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">remaining_ax_names</span><span class="p">:</span>
        <span class="n">full_ax_names</span> <span class="o">+=</span> <span class="n">remaining_ax_names</span>
        <span class="n">full_sel_list</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining_ax_names</span><span class="p">)</span>
        <span class="n">full_newdim_flags</span> <span class="o">+=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining_ax_names</span><span class="p">)</span>

    <span class="c1"># print(&quot;sel0: &quot;, sel_list0, &#39;\n&#39;,</span>
    <span class="c1">#       &quot;sel_list: &quot;, sel_list, &#39;\n&#39;,</span>
    <span class="c1">#       &quot;full_ax_names: &quot;, full_ax_names, &#39;\n&#39;,</span>
    <span class="c1">#       &quot;full_sel_list: &quot;, full_sel_list, &#39;\n&#39;,</span>
    <span class="c1">#       &quot;full_newdim_flags: &quot;, full_newdim_flags, &#39;\n&#39;,</span>
    <span class="c1">#       &quot;----\n&quot;,</span>
    <span class="c1">#       &quot;len(full_ax_names): &quot;, len(full_ax_names), &#39;\n&#39;,</span>
    <span class="c1">#       &quot;len(ax_names): &quot;, len(ax_names), &#39;\n&#39;,</span>
    <span class="c1">#       &quot;n_newax: &quot;, n_newax, &#39;\n&#39;,</span>
    <span class="c1">#       sep=&#39;&#39;)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_ax_names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax_names</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_newax</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_sel_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax_names</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_newax</span>

    <span class="k">return</span> <span class="n">full_sel_list</span><span class="p">,</span> <span class="n">full_ax_names</span><span class="p">,</span> <span class="n">full_newdim_flags</span></div>

<span class="c1">#######################################################################</span>

<span class="k">def</span> <span class="nf">_warn_deprecated_float</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">varname</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_emit_deprecated_float_warning</span>  <span class="c1"># pylint: disable=global-statement</span>
    <span class="k">if</span> <span class="n">_emit_deprecated_float_warning</span><span class="p">:</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">_user_written_stack_frame</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;DEPRECATION...</span><span class="se">\n</span><span class="s2">&quot;</span>
             <span class="s2">&quot;Slicing by float is deprecated. Slicing by location is now </span><span class="se">\n</span><span class="s2">&quot;</span>
             <span class="s2">&quot;performed with an imaginary number, or a string with a trailing </span><span class="se">\n</span><span class="s2">&quot;</span>
             <span class="s2">&quot;&#39;f&#39;, as in 0j, &#39;x=0j&#39;, or &#39;x=0f&#39;. This warning comes from:</span><span class="se">\n</span><span class="s2">&quot;</span>
             <span class="s2">&quot;    </span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span>
             <span class="s2">&quot;    &gt;&gt;&gt; </span><span class="si">{2}</span><span class="s2">&quot;</span>
             <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">frame</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">frame</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">_emit_deprecated_float_warning</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">_is_time_str</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">_R_DTIME</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">()</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_split_slice_str</span><span class="p">(</span><span class="n">sel</span><span class="p">):</span>
    <span class="n">all_times</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">_R_DTIME_SLC</span><span class="p">,</span> <span class="n">sel</span><span class="p">)</span>
    <span class="n">at_sel</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_R_DTIME_SLC</span><span class="p">,</span> <span class="s1">&#39;@&#39;</span><span class="p">,</span> <span class="n">sel</span><span class="p">)</span>
    <span class="n">split_sel</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">at_sel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_times</span><span class="p">:</span>
        <span class="n">split_sel</span><span class="p">[</span><span class="n">split_sel</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">s</span>
    <span class="k">return</span> <span class="n">split_sel</span>

<span class="c1">#######################################################################</span>

<div class="viewcode-block" id="standardize_sel_list"><a class="viewcode-back" href="../../api/viscid.sliceutil.html#viscid.standardize_sel_list">[docs]</a><span class="k">def</span> <span class="nf">standardize_sel_list</span><span class="p">(</span><span class="n">sel_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;turn all selection list elements into fundamental python types&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sel_list</span><span class="p">):</span>
        <span class="n">sel_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">standardize_sel</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sel_list</span></div>

<div class="viewcode-block" id="standardize_sel"><a class="viewcode-back" href="../../api/viscid.sliceutil.html#viscid.standardize_sel">[docs]</a><span class="k">def</span> <span class="nf">standardize_sel</span><span class="p">(</span><span class="n">sel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;turn selection list element into fundamental python types&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">sel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;[&#39;</span> <span class="ow">and</span> <span class="n">sel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;]&#39;</span><span class="p">:</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">standardize_value</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">bool_argwhere</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">:</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">standardize_value</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">bool_argwhere</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">_split_slice_str</span><span class="p">(</span><span class="n">sel</span><span class="p">)])</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">))</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">standardize_value</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">bool_argwhere</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">standardize_value</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">bool_argwhere</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="n">sel</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">sel</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">sel</span><span class="o">.</span><span class="n">step</span><span class="p">]])</span>
        <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">sel</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="n">standardize_value</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">bool_argwhere</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sel</span></div>

<div class="viewcode-block" id="standardize_value"><a class="viewcode-back" href="../../api/viscid.sliceutil.html#viscid.standardize_value">[docs]</a><span class="k">def</span> <span class="nf">standardize_value</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">bool_argwhere</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Turn a value element to fundamental type or array</span>

<span class="sd">    Returns:</span>
<span class="sd">        One of the following::</span>
<span class="sd">            - None</span>
<span class="sd">            - np.newaxis</span>
<span class="sd">            - Ellipsis</span>
<span class="sd">            - bool</span>
<span class="sd">            - int</span>
<span class="sd">            - complex (slice by value)</span>
<span class="sd">            - numpy.datetime64</span>
<span class="sd">            - numpy.timedelta64</span>
<span class="sd">            - ndarray</span>
<span class="sd">                - numpy.integer</span>
<span class="sd">                - numpy.bool\_</span>
<span class="sd">                - numpy.timedelta64</span>
<span class="sd">                - numpy.datetime64</span>
<span class="sd">                - numpy.complex</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">)):</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="p">(</span><span class="nb">complex</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">complex</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">complexfloating</span><span class="p">)):</span>
        <span class="k">assert</span> <span class="n">sel</span><span class="o">.</span><span class="n">real</span> <span class="o">==</span> <span class="mf">0.0</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">)):</span>
        <span class="n">_warn_deprecated_float</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">sel</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">complex</span><span class="p">,</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">complexfloating</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">bool_argwhere</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)):</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">sel</span> <span class="ow">in</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="bp">Ellipsis</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sel</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;newaxis&#39;</span><span class="p">,</span> <span class="s1">&#39;numpy.newaxis&#39;</span><span class="p">,</span> <span class="s1">&#39;np.newaxis&#39;</span><span class="p">):</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span>
        <span class="k">elif</span> <span class="n">sel</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">sel</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">sel</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">sel</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">,</span> <span class="s1">&#39;ellipsis&#39;</span><span class="p">):</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="bp">Ellipsis</span>
        <span class="k">elif</span> <span class="n">sel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;[&#39;</span> <span class="ow">and</span> <span class="n">sel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;]&#39;</span><span class="p">:</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">sel</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;true&#39;</span> <span class="ow">in</span> <span class="n">sel</span> <span class="ow">or</span> <span class="s1">&#39;false&#39;</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
                <span class="n">_orig_sel</span> <span class="o">=</span> <span class="n">sel</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bool_argwhere</span><span class="p">:</span>
                    <span class="n">sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sel</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;bool array as string did not parse: [</span><span class="si">{0}</span><span class="s2">]&quot;</span>
                                     <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_orig_sel</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;j&#39;</span><span class="p">)</span>
                <span class="n">n_js</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;j&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n_js</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">_orig_sel</span> <span class="o">=</span> <span class="n">sel</span>
                    <span class="n">sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">split</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">complex</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">sel</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">imag</span>
                    <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">():</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;float array as string did not parse: &quot;</span>
                                         <span class="s2">&quot;[</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_orig_sel</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">n_js</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel</span><span class="p">):</span>
                        <span class="n">_warn_deprecated_float</span><span class="p">(</span><span class="n">_orig_sel</span><span class="p">)</span>
                    <span class="n">sel</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">sel</span>
                <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">_is_time_str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sel</span><span class="o">.</span><span class="n">split</span><span class="p">()):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">sel</span> <span class="o">=</span> <span class="n">as_timedelta64</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;ut&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sel</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="n">sel</span> <span class="o">=</span> <span class="n">as_datetime64</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;ut&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sel</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">_is_time_str</span><span class="p">(</span><span class="n">sel</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">as_timedelta64</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;ut&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">as_datetime64</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;ut&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;j&#39;</span> <span class="ow">in</span> <span class="n">sel</span> <span class="ow">or</span> <span class="s1">&#39;f&#39;</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">:</span>
                        <span class="n">sel</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;j&#39;</span><span class="p">)</span>
                        <span class="n">sel</span> <span class="o">=</span> <span class="nb">complex</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sel</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
                        <span class="n">_warn_deprecated_float</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
                        <span class="n">sel</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">sel</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected std type &#39;</span><span class="si">{0}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sel</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">is_timedelta_like</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">conservative</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="n">as_timedelta64</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">is_datetime_like</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">conservative</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="n">as_datetime64</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected std type &#39;</span><span class="si">{0}</span><span class="s2">&#39; (</span><span class="si">{1}</span><span class="s2">)&quot;</span>
                         <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">sel</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">sel</span></div>

<span class="c1">#######################################################################</span>

<div class="viewcode-block" id="std_sel_list2index"><a class="viewcode-back" href="../../api/viscid.sliceutil.html#viscid.std_sel_list2index">[docs]</a><span class="k">def</span> <span class="nf">std_sel_list2index</span><span class="p">(</span><span class="n">std_sel_list</span><span class="p">,</span> <span class="n">crd_arrs</span><span class="p">,</span> <span class="n">val_endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interior</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">tdunit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;turn standardized selection list into index slice&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">std_sel2index</span><span class="p">(</span><span class="n">std_sel</span><span class="p">,</span> <span class="n">crd_arr</span><span class="p">,</span> <span class="n">val_endpoint</span><span class="o">=</span><span class="n">val_endpoint</span><span class="p">,</span>
                          <span class="n">interior</span><span class="o">=</span><span class="n">interior</span><span class="p">,</span> <span class="n">tdunit</span><span class="o">=</span><span class="n">tdunit</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">std_sel</span><span class="p">,</span> <span class="n">crd_arr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">std_sel_list</span><span class="p">,</span> <span class="n">crd_arrs</span><span class="p">)</span>
            <span class="p">]</span></div>

<div class="viewcode-block" id="std_sel2index"><a class="viewcode-back" href="../../api/viscid.sliceutil.html#viscid.std_sel2index">[docs]</a><span class="k">def</span> <span class="nf">std_sel2index</span><span class="p">(</span><span class="n">std_sel</span><span class="p">,</span> <span class="n">crd_arr</span><span class="p">,</span> <span class="n">val_endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interior</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">tdunit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Turn single standardized selection into slice (by int or None)</span>

<span class="sd">    Normally (val_endpoint=True, interior=False), the rules for float</span>
<span class="sd">    lookup val_endpoints are::</span>

<span class="sd">        - The slice will never include an element whose value in arr</span>
<span class="sd">          is &lt; start (or &gt; if the slice is backward)</span>
<span class="sd">        - The slice will never include an element whose value in arr</span>
<span class="sd">          is &gt; stop (or &lt; if the slice is backward)</span>
<span class="sd">        - !! The slice WILL INCLUDE stop if you don&#39;t change</span>
<span class="sd">          val_endpoint. This is different from normal slicing, but</span>
<span class="sd">          it&#39;s more natural when specifying a slice as a float.</span>

<span class="sd">    If interior=True, then the slice is expanded such that start and</span>
<span class="sd">    stop are interior to the sliced array.</span>

<span class="sd">    Args:</span>
<span class="sd">        std_sel: single standardized selection</span>
<span class="sd">        arr (ndarray): filled with floats to do the lookup</span>
<span class="sd">        val_endpoint (bool): iff True then include stop in the slice when</span>
<span class="sd">            slicing-by-value (DOES NOT EFFECT SLICE-BY-INDEX).</span>
<span class="sd">            Set to False to get python slicing symantics when it</span>
<span class="sd">            comes to excluding stop, but fair warning, python</span>
<span class="sd">            symantics feel awkward here. Consider the case</span>
<span class="sd">            [0.1, 0.2, 0.3][:0.25]. If you think this should include</span>
<span class="sd">            0.2, then leave keep val_endpoint=True.</span>
<span class="sd">        interior (bool): if True, then extend both ends of the slice</span>
<span class="sd">            such that slice-by-value endpoints are interior to the</span>
<span class="sd">            slice</span>
<span class="sd">        epoch (datetime64-like): Epoch for to go datetime64 &lt;-&gt; float</span>
<span class="sd">        tdunit (str): Presumed time unit for floats</span>
<span class="sd">        tol (int): number of machine epsilons to consider</span>
<span class="sd">            &quot;close enough&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">interior</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">val_endpoint</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;For interior slices, val_endpoint must be True, I&#39;ll &quot;</span>
                       <span class="s2">&quot;change that for you.&quot;</span><span class="p">)</span>
        <span class="n">val_endpoint</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">std_sel</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">std_sel</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)))</span>
        <span class="n">start_val</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">stop_val</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">orig_step</span> <span class="o">=</span> <span class="n">std_sel</span><span class="o">.</span><span class="n">step</span>
        <span class="n">ustep</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">std_sel</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">std_sel</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
        <span class="n">sgn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">ustep</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">std_sel</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)))</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">std_sel</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">))):</span>
            <span class="n">ustart</span> <span class="o">=</span> <span class="n">std_sel</span><span class="o">.</span><span class="n">start</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ustart</span><span class="p">,</span> <span class="n">tol</span> <span class="o">=</span> <span class="n">_unify_sbv_types</span><span class="p">(</span><span class="n">std_sel</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">crd_arr</span><span class="p">,</span> <span class="n">tdunit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span>
                                           <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
            <span class="n">start_val</span> <span class="o">=</span> <span class="n">ustart</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">crd_arr</span> <span class="o">-</span> <span class="n">ustart</span> <span class="o">+</span> <span class="p">(</span><span class="n">tol</span> <span class="o">*</span> <span class="n">sgn</span><span class="p">)</span>
            <span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">dtype</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">ustep</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_less</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_greater</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># start value is past the wrong end of the array</span>
                <span class="k">if</span> <span class="n">ustep</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ustart</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">crd_arr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># start = -len(arr) - 1</span>
                    <span class="c1"># having a value &lt; -len(arr) won&#39;t play</span>
                    <span class="c1"># nice with make_fwd_slice, but in this</span>
                    <span class="c1"># case, the slice will have no data, so...</span>
                    <span class="k">return</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ustep</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ustart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">std_sel</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)))</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">std_sel</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">))):</span>
            <span class="n">ustop</span> <span class="o">=</span> <span class="n">std_sel</span><span class="o">.</span><span class="n">stop</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ustop</span><span class="p">,</span> <span class="n">tol</span> <span class="o">=</span> <span class="n">_unify_sbv_types</span><span class="p">(</span><span class="n">std_sel</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">crd_arr</span><span class="p">,</span> <span class="n">tdunit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span>
                                          <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
            <span class="n">stop_val</span> <span class="o">=</span> <span class="n">ustop</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">crd_arr</span> <span class="o">-</span> <span class="n">ustop</span> <span class="o">-</span> <span class="p">(</span><span class="n">tol</span> <span class="o">*</span> <span class="n">sgn</span><span class="p">)</span>
            <span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">dtype</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">ustep</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_greater</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_less</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ustep</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ustop</span> <span class="o">&lt;</span> <span class="n">crd_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="c1"># stop value is past the wong end of the array</span>
                    <span class="n">ustop</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ustop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">val_endpoint</span><span class="p">:</span>
                        <span class="n">ustop</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ustop</span> <span class="o">&gt;</span> <span class="n">crd_arr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="c1"># stop value is past the wrong end of the array</span>
                    <span class="n">ustop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">crd_arr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ustop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">val_endpoint</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ustop</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">ustop</span> <span class="o">-=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># 0 - 1 == -1 which would wrap to the end of</span>
                            <span class="c1"># of the array... instead, just make it None</span>
                            <span class="n">ustop</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">ustart</span><span class="p">,</span> <span class="n">ustop</span><span class="p">,</span> <span class="n">orig_step</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">interior</span><span class="p">:</span>
            <span class="n">_a</span><span class="p">,</span> <span class="n">_b</span><span class="p">,</span> <span class="n">_c</span> <span class="o">=</span> <span class="n">_interiorize_slice</span><span class="p">(</span><span class="n">crd_arr</span><span class="p">,</span> <span class="n">start_val</span><span class="p">,</span> <span class="n">stop_val</span><span class="p">,</span>
                                            <span class="n">idx</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">idx</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">idx</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">_a</span><span class="p">,</span> <span class="n">_b</span><span class="p">,</span> <span class="n">_c</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># slice by single value or ndarray of single values (int, float, times)</span>
        <span class="n">usel</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_unify_sbv_types</span><span class="p">(</span><span class="n">std_sel</span><span class="p">,</span> <span class="n">crd_arr</span><span class="p">,</span> <span class="n">tdunit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">usel</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)))</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">usel</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">))):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">usel</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">usel</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">usel</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">usel</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">crd_arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">usel</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">crd_arr</span> <span class="o">-</span> <span class="n">usel</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">idx</span></div>

<span class="k">def</span> <span class="nf">_unify_sbv_types</span><span class="p">(</span><span class="n">std_val</span><span class="p">,</span> <span class="n">crd_arr</span><span class="p">,</span> <span class="n">tdunit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">uval</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">std_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">std_val</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">))</span>
          <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">std_val</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">))):</span>
        <span class="n">uval</span><span class="p">,</span> <span class="n">tol</span> <span class="o">=</span> <span class="n">std_val</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">std_val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">std_val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)</span>
          <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">std_val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">))):</span>
        <span class="n">uval</span><span class="p">,</span> <span class="n">tol</span> <span class="o">=</span> <span class="n">std_val</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ndarray_slice</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">std_val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
        <span class="n">std_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">std_val</span><span class="p">)</span>
        <span class="n">len_std_val</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">std_val</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">()</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">std_val</span><span class="p">)</span>
        <span class="n">std_val</span> <span class="o">=</span> <span class="n">std_val</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">len_std_val</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">std_val</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">complex</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">complexfloating</span><span class="p">)):</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">std_val</span><span class="o">.</span><span class="n">real</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">std_val</span> <span class="o">=</span> <span class="n">std_val</span><span class="o">.</span><span class="n">imag</span>

        <span class="k">if</span> <span class="n">crd_arr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">crd_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">std_val</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">crd_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">crd_arr</span><span class="p">)</span>

        <span class="c1"># ----</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">crd_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">type</span><span class="p">(</span><span class="n">std_val</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])):</span>
            <span class="n">uval</span> <span class="o">=</span> <span class="n">std_val</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">crd_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">std_val</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
                <span class="n">uval</span> <span class="o">=</span> <span class="n">as_timedelta64</span><span class="p">(</span><span class="n">std_val</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">tdunit</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">std_val</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">epoch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t slice-by-value a timedelta64 &quot;</span>
                                              <span class="s2">&quot;axis using datetime64 value without &quot;</span>
                                              <span class="s2">&quot;epoch&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">uval</span> <span class="o">=</span> <span class="n">time_diff</span><span class="p">(</span><span class="n">std_val</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">most_precise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">crd_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">std_val</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
                <span class="n">std_val</span> <span class="o">=</span> <span class="n">as_timedelta64</span><span class="p">(</span><span class="n">std_val</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">tdunit</span><span class="p">)</span>
                <span class="n">uval</span> <span class="o">=</span> <span class="n">crd_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">std_val</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">std_val</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">):</span>
                <span class="n">uval</span> <span class="o">=</span> <span class="n">crd_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">std_val</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">crd_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">std_val</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">):</span>
                <span class="n">uval</span> <span class="o">=</span> <span class="n">std_val</span> <span class="o">/</span> <span class="n">as_timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">tdunit</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">std_val</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">epoch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t slice-by-value a floating pt. &quot;</span>
                                              <span class="s2">&quot;axis using datetime64 value without &quot;</span>
                                              <span class="s2">&quot;epoch&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">uval</span> <span class="o">=</span> <span class="n">time_diff</span><span class="p">(</span><span class="n">std_val</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">most_precise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">uval</span> <span class="o">=</span> <span class="n">uval</span> <span class="o">/</span> <span class="n">as_timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">tdunit</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">std_val</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
                <span class="n">uval</span> <span class="o">=</span> <span class="n">std_val</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">crd_arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;coordinates dtype </span><span class="si">{0}</span><span class="s2"> can not be &quot;</span>
                                      <span class="s2">&quot;sliced by value&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">crd_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>

        <span class="c1"># ----</span>
        <span class="k">if</span> <span class="n">uval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uval</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">crd_arr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">tol</span> <span class="o">=</span> <span class="mf">0.0001</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">crd_arr</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tol</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uval</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">):</span>
            <span class="n">tol</span> <span class="o">=</span> <span class="n">as_timedelta64</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uval</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">):</span>
            <span class="n">tol</span> <span class="o">=</span> <span class="n">as_timedelta64</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">uval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ndarray_slice</span><span class="p">:</span>
            <span class="n">uval</span> <span class="o">=</span> <span class="n">uval</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">uval</span><span class="p">,</span> <span class="n">tol</span>

<span class="k">def</span> <span class="nf">_interiorize_slice</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">start_val</span><span class="p">,</span> <span class="n">stop_val</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span>
                       <span class="n">verify</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensure start_val and stop_val interior to the sliced array</span>

<span class="sd">    Args:</span>
<span class="sd">        arr (sequence): sequence being sliced</span>
<span class="sd">        start_val (None, float): Value used to find start index, or</span>
<span class="sd">            None to not adjust start</span>
<span class="sd">        stop_val (None, float): Value used to find stop index, or</span>
<span class="sd">            None to net adjust stop</span>
<span class="sd">        start (int): start of slice</span>
<span class="sd">        stop (int): stop of slice</span>
<span class="sd">        step (int): step of slice</span>
<span class="sd">        verify (bool): verify that start_val and stop_val are interior</span>
<span class="sd">            to the resulting sequence</span>

<span class="sd">    Returns:</span>
<span class="sd">        (start, stop, step), adusted sliced start:stop:step indices</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">step</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">step</span>

    <span class="k">if</span> <span class="n">start_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">start_slcval</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">start</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">start_slcval</span> <span class="o">&gt;</span> <span class="n">start_val</span><span class="p">:</span>
            <span class="c1"># print(&quot;ADJUSTING start fwd&quot;)</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">step</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">start_slcval</span> <span class="o">&lt;</span> <span class="n">start_val</span><span class="p">:</span>
            <span class="c1"># print(&quot;ADJUSTING start rev&quot;)</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">stop_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">stop_slcval</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">stop</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">arr</span><span class="p">[</span><span class="n">stop</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">stop_slcval</span> <span class="o">&lt;</span> <span class="n">stop_val</span><span class="p">:</span>
                <span class="c1"># print(&quot;ADJUSTING stop fwd&quot;)</span>
                <span class="k">if</span> <span class="n">stop</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">stop</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stop</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">step</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">stop_slcval</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">stop</span> <span class="ow">in</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span> <span class="k">else</span> <span class="n">arr</span><span class="p">[</span><span class="n">stop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">stop_slcval</span> <span class="o">&gt;</span> <span class="n">stop_val</span><span class="p">:</span>
                <span class="c1"># print(&quot;ADJUSTING stop rev&quot;)</span>
                <span class="k">if</span> <span class="n">stop</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">stop</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stop</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="c1"># for debug, check that interior does what it says</span>
    <span class="k">if</span> <span class="n">verify</span><span class="p">:</span>
        <span class="n">subarr</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">step</span><span class="p">]</span>
        <span class="n">ends</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">subarr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">subarr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="n">start_val</span><span class="p">,</span> <span class="n">stop_val</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">ends</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">ends</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Logic issue in interiorize, &quot;</span>
                                       <span class="s2">&quot;v: </span><span class="si">{0}</span><span class="s2"> ends: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">ends</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span>

<span class="c1">#######################################################################</span>

<span class="k">def</span> <span class="nf">raw_sel2values</span><span class="p">(</span><span class="n">arrs</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tdunit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">sel_list2values</span><span class="p">(</span><span class="n">arrs</span><span class="p">,</span> <span class="n">raw_sel2sel_list</span><span class="p">(</span><span class="n">selection</span><span class="p">),</span>
                           <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span> <span class="n">tdunit</span><span class="o">=</span><span class="n">tdunit</span><span class="p">)</span>

<div class="viewcode-block" id="sel_list2values"><a class="viewcode-back" href="../../api/viscid.sliceutil.html#viscid.sel_list2values">[docs]</a><span class="k">def</span> <span class="nf">sel_list2values</span><span class="p">(</span><span class="n">arrs</span><span class="p">,</span> <span class="n">sel_list</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tdunit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;find the extrema values for a given sel list&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">arrs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">arrs</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">sel2values</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span> <span class="n">tdunit</span><span class="o">=</span><span class="n">tdunit</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">arr</span><span class="p">,</span> <span class="n">sel</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">arrs</span><span class="p">,</span> <span class="n">sel_list</span><span class="p">)]</span></div>

<div class="viewcode-block" id="sel2values"><a class="viewcode-back" href="../../api/viscid.sliceutil.html#viscid.sel2values">[docs]</a><span class="k">def</span> <span class="nf">sel2values</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tdunit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;find the extrema values for a given selection</span>

<span class="sd">    Args:</span>
<span class="sd">        arr (None, sequence): array that is being selected, if this is</span>
<span class="sd">            None, then the output will contain np.nan where it can not</span>
<span class="sd">            infer values.</span>
<span class="sd">        selection (slice, str): a single selection that could be given</span>
<span class="sd">            to :py:func:`to_slice`</span>
<span class="sd">        epoch (datetime64-like): Epoch for to go datetime64 &lt;-&gt; float</span>
<span class="sd">        tdunit (str): Presumed time unit for floats</span>

<span class="sd">    Returns:</span>
<span class="sd">        (start_val, stop_val) as floats</span>

<span class="sd">        - If arr is None and start/stop are None, then they will become</span>
<span class="sd">          +/- inf depending on the sign of step.</span>
<span class="sd">        - If arr is None and start/stop are slice-by-index, they will</span>
<span class="sd">          become NaN.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">std_sel</span> <span class="o">=</span> <span class="n">standardize_sel</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">std_sel</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">std_sel</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">std_sel</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="s1">&#39;__index__&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">arr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">std_sel</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">std_sel</span><span class="o">.</span><span class="n">step</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ustart</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="k">elif</span> <span class="n">std_sel</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">std_sel</span><span class="o">.</span><span class="n">step</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ustart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ustart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">std_sel</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">std_sel</span><span class="o">.</span><span class="n">step</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">std_sel</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
                <span class="n">ustart</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ustart</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_unify_sbv_types</span><span class="p">(</span><span class="n">std_sel</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">tdunit</span><span class="o">=</span><span class="n">tdunit</span><span class="p">,</span>
                                         <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">std_sel</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">std_sel</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="s1">&#39;__index__&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">arr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">std_sel</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">std_sel</span><span class="o">.</span><span class="n">step</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ustop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="k">elif</span> <span class="n">std_sel</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">std_sel</span><span class="o">.</span><span class="n">step</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ustop</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ustop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">std_sel</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">std_sel</span><span class="o">.</span><span class="n">step</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">std_sel</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
                <span class="n">ustop</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ustop</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_unify_sbv_types</span><span class="p">(</span><span class="n">std_sel</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">tdunit</span><span class="o">=</span><span class="n">tdunit</span><span class="p">,</span>
                                        <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">ustart</span><span class="p">,</span> <span class="n">ustop</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">std_sel</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">):</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">std_sel</span><span class="p">,</span> <span class="s2">&quot;__index__&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">arr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">arr</span><span class="p">[</span><span class="n">std_sel</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">uval</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_unify_sbv_types</span><span class="p">(</span><span class="n">std_sel</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">tdunit</span><span class="o">=</span><span class="n">tdunit</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">uval</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span></div>

<span class="n">selection2values</span> <span class="o">=</span> <span class="n">sel2values</span>

<span class="c1">#######################################################################</span>

<span class="c1"># FIXME: is this graceful on slice-by-ndarray?</span>

<div class="viewcode-block" id="make_fwd_slice"><a class="viewcode-back" href="../../api/viscid.sliceutil.html#viscid.make_fwd_slice">[docs]</a><span class="k">def</span> <span class="nf">make_fwd_slice</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">slices</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cull_second</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make sure slices go forward</span>

<span class="sd">    This function returns two slices equivalent to `slices` such</span>
<span class="sd">    that the first slice always goes forward. This is necessary because</span>
<span class="sd">    h5py can&#39;t deal with reverse slices such as [::-1].</span>

<span class="sd">    The optional `reverse` can be used to interpret a dimension as</span>
<span class="sd">    flipped. This is used if the indices in a slice are based on a</span>
<span class="sd">    coordinate array that has already been flipped. For instance, the</span>
<span class="sd">    result is equivalent to `arr[::-1][slices]`, but in a way that can</span>
<span class="sd">    be  handled by h5py. This lets us efficiently load small subsets</span>
<span class="sd">    of large arrays on disk, which is most useful when the large array</span>
<span class="sd">    is coming through sshfs.</span>

<span class="sd">    Note:</span>
<span class="sd">        The only restriction on slices is that neither start nor stop</span>
<span class="sd">        can be outide the range [-L, L].</span>

<span class="sd">    Args:</span>
<span class="sd">        shape: shape of the array that is to be sliced</span>
<span class="sd">        slices: a tuple of slices to work with</span>
<span class="sd">        reverse (optional): list of bools that indicate if the</span>
<span class="sd">            corresponding value in slices should be ineterpreted as</span>
<span class="sd">            flipped</span>
<span class="sd">        cull_second (bool, optional): iff True, remove elements of</span>
<span class="sd">            the second slice for dimensions that don&#39;t exist after</span>
<span class="sd">            the first slice has completed. This is only here for</span>
<span class="sd">            a super-hacky case when slicing fields.</span>
<span class="sd">    Returns:</span>
<span class="sd">        (first_slice, second_slice)</span>

<span class="sd">        * first_slice: a forward-only slice that retrieves the</span>
<span class="sd">          desired elements of an array</span>
<span class="sd">        * second_slice: a slice that does [::1] or [::-1] as needed</span>
<span class="sd">          to make the result equivalent to slices. If keep_all,</span>
<span class="sd">          then this may contain None indicating that this</span>
<span class="sd">          dimension no longer exists after the first slice.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt; a = np.arange(8)</span>
<span class="sd">        &gt;&gt; first, second = make_fwd_slice(len(a),slice(None, None, -1))</span>
<span class="sd">        &gt;&gt; (a[::-1] == a[first][second]).all()</span>
<span class="sd">        True</span>

<span class="sd">        &gt;&gt; a = np.arange(4*5*6).reshape((4, 5, 6))</span>
<span class="sd">        &gt;&gt; first, second = make_fwd_slice(a.shape,</span>
<span class="sd">        &gt;&gt;                                [slice(None, -1, 1),</span>
<span class="sd">        &gt;&gt;                                 slice(-1, None, 1),</span>
<span class="sd">        &gt;&gt;                                 slice(-4, -1, 2)],</span>
<span class="sd">        &gt;&gt;                                [True, True, True])</span>
<span class="sd">        &gt;&gt; a1 = a[::-1, ::-1, ::-1][:-1, -1:, -4:-1:2]</span>
<span class="sd">        &gt;&gt; a2 = a[first][second]</span>
<span class="sd">        &gt;&gt; a1 == a2</span>
<span class="sd">        True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">reverse</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">reverse</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">shape</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slices</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">slices</span> <span class="o">=</span> <span class="p">[</span><span class="n">slices</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">reverse</span> <span class="o">=</span> <span class="p">[</span><span class="n">reverse</span><span class="p">]</span>

    <span class="n">newax_inds</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">slices</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">newax_inds</span><span class="p">:</span>
        <span class="n">shape</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># ya know, lets just go through all the dimensions in shape</span>
    <span class="c1"># just to be safe and default to an empty slice / no reverse</span>
    <span class="n">slices</span> <span class="o">=</span> <span class="n">slices</span> <span class="o">+</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">slices</span><span class="p">))</span>
    <span class="n">reverse</span> <span class="o">=</span> <span class="n">reverse</span> <span class="o">+</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slices</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">reverse</span><span class="p">))</span>

    <span class="n">first_slc</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">slices</span><span class="p">)</span>
    <span class="n">second_slc</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">first_slc</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">slc</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">rev</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="n">count</span><span class="p">(),</span> <span class="n">slices</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slc</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">step</span> <span class="o">=</span> <span class="n">slc</span><span class="o">.</span><span class="n">step</span> <span class="k">if</span> <span class="n">slc</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">slc</span><span class="o">.</span><span class="n">start</span> <span class="k">if</span> <span class="n">slc</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">slc</span><span class="o">.</span><span class="n">stop</span> <span class="k">if</span> <span class="n">slc</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">L</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">+=</span> <span class="n">L</span>
            <span class="k">if</span> <span class="n">stop</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">stop</span> <span class="o">+=</span> <span class="n">L</span>

            <span class="c1"># sanity check the start/stop since we&#39;re gunna be playing</span>
            <span class="c1"># fast and loose with them</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">stop</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;((start = </span><span class="si">{0}</span><span class="s2">) or (stop = </span><span class="si">{1}</span><span class="s2">)) &lt; 0&quot;</span>
                                 <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">L</span> <span class="ow">or</span> <span class="n">stop</span> <span class="o">&gt;</span> <span class="n">L</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;((start=</span><span class="si">{0}</span><span class="s2">) or (stop=</span><span class="si">{1}</span><span class="s2">)) &gt; (L=</span><span class="si">{2}</span><span class="s2">)&quot;</span>
                                 <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">L</span><span class="p">))</span>

            <span class="c1"># now do the math of flipping the slice if needed, these branches</span>
            <span class="c1"># change start, stop, and step so they can be used to create a new</span>
            <span class="c1"># slice below</span>
            <span class="k">if</span> <span class="n">rev</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">step</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">step</span> <span class="o">=</span> <span class="o">-</span><span class="n">step</span>
                    <span class="k">if</span> <span class="n">slc</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">start</span> <span class="o">=</span> <span class="n">L</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">slc</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">start</span> <span class="o">=</span> <span class="n">L</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">start</span>
                        <span class="n">stop</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">L</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="n">L</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">stop</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">L</span> <span class="o">-</span> <span class="n">stop</span><span class="p">,</span> <span class="n">L</span> <span class="o">-</span> <span class="n">start</span>
                    <span class="n">start</span> <span class="o">+=</span> <span class="p">((</span><span class="n">stop</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">%</span> <span class="n">step</span><span class="p">)</span>
                    <span class="n">second_slc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">step</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">step</span> <span class="o">=</span> <span class="o">-</span><span class="n">step</span>
                <span class="k">if</span> <span class="n">slc</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="n">L</span> <span class="o">-</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">slc</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="p">((</span><span class="n">stop</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">%</span> <span class="n">step</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">start</span> <span class="o">+=</span> <span class="p">((</span><span class="n">stop</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">%</span> <span class="n">step</span><span class="p">)</span>

                <span class="n">second_slc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># check that our slice is valid</span>
            <span class="k">assert</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="n">L</span><span class="p">),</span> \
                <span class="s2">&quot;start (=</span><span class="si">{0}</span><span class="s2">) is outside range&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="n">L</span><span class="p">),</span> \
                <span class="s2">&quot;start (=</span><span class="si">{0}</span><span class="s2">) is outside range&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">start</span> <span class="o">==</span> <span class="n">stop</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> \
                <span class="n">start</span> <span class="o">&lt;</span> <span class="n">stop</span><span class="p">,</span> <span class="s2">&quot;bad slice ordering: </span><span class="si">{0}</span><span class="s2"> !&lt; </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">step</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">slc</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slc</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
            <span class="n">second_slc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">rev</span><span class="p">:</span>
                <span class="n">slc</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">slc</span>

        <span class="k">elif</span> <span class="n">slc</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">:</span>
            <span class="n">second_slc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;NEWAXIS&quot;</span>

        <span class="n">first_slc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">slc</span>

    <span class="n">first_slc</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">first_slc</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">cull_second</span><span class="p">:</span>
        <span class="n">second_slc</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">second_slc</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">second_slc</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span> <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="s2">&quot;NEWAXIS&quot;</span> <span class="k">else</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">second_slc</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">first_slc</span><span class="p">,</span> <span class="n">second_slc</span></div>

<span class="c1">#######################################################################</span>

<div class="viewcode-block" id="all_slices_none"><a class="viewcode-back" href="../../api/viscid.sliceutil.html#viscid.all_slices_none">[docs]</a><span class="k">def</span> <span class="nf">all_slices_none</span><span class="p">(</span><span class="n">slices</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;true iff all slices have no effect&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span>
               <span class="ow">and</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
               <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">_user_written_stack_frame</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;get the frame of first stack frame outside Viscid&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">inspect</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="n">stack</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
    <span class="n">frame_info</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">frame_info</span> <span class="ow">in</span> <span class="n">stack</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;viscid&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">frame_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">frame_info</span>

<span class="c1">##</span>
<span class="c1">## EOF</span>
<span class="c1">##</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2018, Kristofor Maynard.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.6.<br/>
    </p>
  </div>
</footer>
  </body>
</html>